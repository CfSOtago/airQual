---
params:
  title: ''
  subtitle: ''
  authors: ''
title: '`r params$title`'
subtitle: '`r params$subtitle`'
author: '`r params$authors`'
date: 'Last run at: `r getRunDateTime()`'
output:
  bookdown::html_document2:
    fig_caption: yes
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: TRUE
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: yes
  bookdown::word_document2:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
    fig_width: 5
always_allow_html: yes
bibliography: '`r path.expand("~/bibliography.bib")`'
---

```{r knitrSetUp, include=FALSE}

# Set knitr options
knitr::opts_chunk$set(echo = FALSE,          # echo code so reader can see what is happening
                      warning = FALSE,
                      message = FALSE,
                      fig_caption = TRUE,
                      fig_height = 6,        # default, make it bigger to stretch vertical axis
                      fig_width = 8,
                      fig_width = 8,         # full width
                      tidy = TRUE)           # tidy up code in case echo = TRUE

```


```{r codeSetup, include=FALSE}

# Load Packages ----
rmdLibs <- c("ggplot2",
            "kableExtra",
            "plotly",
            "skimr",
            "viridis")

dkUtils::loadLibraries(rmdLibs)

# Adjust knitr options if required
knitr::opts_chunk$set(echo = TRUE)

# Log compile time:
myParams$startTime <- proc.time()

# Parameters ----
# set xlim for plotly to reduce plot size & load speed
myParams$xlimMinDateTime <- lubridate::as_datetime("2018-01-01 00:00:00")
myParams$xlimMaxDateTime <- lubridate::as_datetime("2020-06-01 00:00:00")
myParams$xlimMinDate <- lubridate::as_date("2018-01-01")
myParams$xlimMaxDate <- lubridate::as_date("2020-06-01")

myParams$oneYearAgo <- lubridate::as_datetime(now() - (365*24*60*60))

# set values for annotations
myParams$lockDownStartDate <- as.Date("2020-03-24")
myParams$lockDownStartDateTime <- lubridate::as_datetime("2020-03-24 00:00:00")
myParams$lockDownEndDate <- lubridate::today()
myParams$lockDownEndDateTime <- lubridate::now()

myParams$recentCutDate <- lubridate::as_date("2020-03-01")

myParams$gamCap <- "Trend line = Generalized additive model (gam) with integrated smoothness estimation"
myParams$lockdownCap <- "\nColoured rectangle = UK covid lockdown to date"
myParams$weekendCap <- "\nShaded rectangle = weekends"

myParams$myAlpha <- 0.1
myParams$vLineAlpha <- 0.4
myParams$vLineCol <- "red" # http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/#a-colorblind-friendly-palette
myParams$myTextSize <- 4

# Functions ----
makeDotPlot <- function(dt, xVar, yVar, byVar, yLab){
  p <- ggplot2::ggplot(dt, aes(x = get(xVar), 
                               y = get(yVar),
                               colour = get(byVar),
                               #alpha = 1/100 # https://ggplot2.tidyverse.org/reference/geom_point.html
                               )
                       ) +
    geom_point(size = 1, # small
               shape = 4 # small cross shape
               ) +
    scale_colour_viridis_d(name = eval(byVar)) +
    guides(alpha = FALSE) + # remove alpha legend 
    labs(x = "Time",
         y = eval(yLab)) +  
    theme(legend.position="bottom") +
    guides(colour = guide_legend(nrow = 2)) # forces 2 rows to legend
  return(p)
}

makeTilePlot <- function(dt, xVar, yVar, fillVar, yLab){
  p <- ggplot2::ggplot(dt, aes(x = get(xVar), 
                               y = get(yVar),
                               fill = get(fillVar)
                               )
                       ) +
    geom_tile() +
    scale_fill_continuous(low = "green", high = "red", name = "Value") +
    labs(x = "Time",
         y = yLab) +  
    theme(legend.position="bottom")
  return(p)
}

compareYearsPlot <- function(dt){
  p <- ggplot2::ggplot(dt, aes(x = dayOfYear, y = mean, 
                               colour = compareYear)) +
    geom_line() +
    scale_x_date(date_breaks = "7 day", date_labels =  "%a %d %b")  +
    theme(axis.text.x=element_text(angle=90, hjust=1)) +
    labs(x = "Date",
         y = "Daily mean",
         caption = paste0(myParams$lockdownCap, myParams$weekendCap)) +  
    theme(legend.position="bottom") +
    scale_colour_discrete(name = "Period")
  return(p)
}
addLockdownDate <- function(p){
  # assumes p has x = obsDate
  # p <- p + annotate("text", x = myParams$lockDownStartDate, 
  #            y = yMax * 0.4, angle = 10,size = myParams$myTextSize,
  #            label = "UK covid lockdown to date", hjust = 0.5)
  p <- p + annotate("rect", xmin = myParams$lockDownStartDate,
             xmax = myParams$lockDownEndDate, 
             ymin = yMin, ymax = yMax, 
             alpha = myParams$myAlpha, 
             fill = myParams$vLineCol, 
             colour = myParams$vLineCol)
  return(p)
}

addLockdownDateTime <- function(p){
  # assumes p has x = obsDateTime
  # p <- p + annotate("text", x = myParams$lockDownStartDateTime, 
  #            y = yMax * 0.4, angle = 10,size = myParams$myTextSize,
  #            label = "UK covid lockdown to date", hjust = 0.5)
  p <- p + annotate("rect", xmin = myParams$lockDownStartDateTime,
             xmax = myParams$lockDownEndDateTime, 
             ymin = yMin, ymax = yMax, 
             alpha = myParams$myAlpha, 
             fill = myParams$vLineCol, 
             colour = myParams$vLineCol) 
    
  return(p)
}

# only makes sense to use these for x axis covering March onwards
myParams$weAlpha <- 0.3
myParams$weFill <- "grey50"
addWeekendsDate <- function(p){
  p <- p + annotate("rect", xmin = as.Date("2020-03-07"),
                    xmax = as.Date("2020-03-08"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("rect", xmin = as.Date("2020-03-14"),
                    xmax = as.Date("2020-03-15"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("rect", xmin = as.Date("2020-03-21"),
                    xmax = as.Date("2020-03-22"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("rect", xmin = as.Date("2020-03-28"),
                    xmax = as.Date("2020-03-29"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("rect", xmin = as.Date("2020-04-04"),
                    xmax = as.Date("2020-04-05"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  return(p)
}

addWeekendsDateTime <- function(p){
   p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-03-07 00:00:00"),
                    xmax = lubridate::as_datetime("2020-03-08 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-03-14 00:00:00"),
                    xmax = lubridate::as_datetime("2020-03-15 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-03-21 00:00:00"),
                    xmax = lubridate::as_datetime("2020-03-22 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-03-28 00:00:00"),
                    xmax = lubridate::as_datetime("2020-03-29 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-04-04 00:00:00"),
                    xmax = lubridate::as_datetime("2020-04-05 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  return(p)
}
```

# About

## Code

 * https://github.com/CfSOtago/airQual/commits/master

## Citation

If you wish to refer to any of the material from this report please cite as:

 * Anderson, B., (`r format(Sys.time(), format = "%Y")`) `r params$title`: `r params$subtitle` , [Sustainable Energy Research Group](http://www.energy.soton.ac.uk), University of Southampton: Southampton, UK.

Report circulation:

 * Public
 
This work is (c) `r format(Sys.time(), format = "%Y")` the University of Southampton.

## Disclaimer

> I usually do energy demand research but in the absence of access to real time demand data on lockdown (unlike during the [World Cup](http://www.energy.soton.ac.uk/the-end-of-the-world-cup/)) I'm looking at other things.
 
# Introduction

Data for Southampton downloaded from :

 * http://southampton.my-air.uk. See also https://www.southampton.gov.uk/environmental-issues/pollution/air-quality/

Southampton City Council collects various forms of air quality data at the sites shown in \@ref(tab:showSites). Some of these sites feed data to [AURN](https://uk-air.defra.gov.uk/networks/network-info?view=aurn). The data that goes to AURN is then [ratifified](https://uk-air.defra.gov.uk/assets/documents/Data_Validation_and_Ratification_Process_Apr_2017.pdf) to check for outliers and instrument/measurement error. AURN data less than six months old has not undergone this process. Given that we are interested in very recent patterns, we do not use the AURN data.

> Data health warning: The southampton.my-air.uk data used is _not_ ratified. Results here should therefore be considered _preliminary_. 

For much more detailed analysis see a longer and very messy [data report](https://cfsotago.github.io/airQual/sccAirQualExplore_Exploring%20the%20SSC%20and%20AURN%20data.html).

```{r prepData}
sotonAirDT <- sotonAirDT[source == "southampton.my-air.uk"] 

sotonAirDT[, obsDate := lubridate::date(dateTimeUTC)]

# this is such a kludge
sotonAirDT[, dateDecimal := lubridate::decimal_date(obsDate)]
sotonAirDT[, year := lubridate::year(obsDate)]
sotonAirDT[, dayOfYear := lubridate::as_date(lubridate::date_decimal(2020 + (dateDecimal - year)))] # sets 'year' portion to 2020 so the lockdown annotation works
sotonAirDT[, compareYear := ifelse(year == 2020, "2020",
                              "2016-2019")]

```

```{r showSites}
sotonAirDT[, site := ifelse(site == "Southampton A33", "Southampton A33 (via AURN)", site)]
sotonAirDT[, site := ifelse(site == "Southampton Centre", "Southampton Centre (via AURN)", site)]
t <- sotonAirDT[!is.na(value),.(nObs = .N,
           nPollutants = uniqueN(pollutant)), keyby = .(site, source)]

kableExtra::kable(t, caption = "Sites, data source and number of valid observations",
                  digits = 2) %>%
  kable_styling()
```


# Nitrogen Dioxide (no2)


```{r No2Summary}
yLab <- "Nitrogen Dioxide (ug/m3)"
no2dt <- sotonAirDT[pollutant == "no2"]
```

Figure \@ref(fig:no2recent) shows the most recent hourly data.

```{r no2recent, fig.cap="Nitrogen Dioxide levels, Southampton (hourly, recent)"}
recentDT <- no2dt[!is.na(value) & obsDate > myParams$recentCutDate]
p <- makeDotPlot(recentDT, 
                 xVar = "dateTimeUTC", 
                 yVar = "value", 
                 byVar = "site", 
                 yLab = yLab)

p <- p +
  scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap))

# final plot - adds annotations
yMin <- min(recentDT$value)
yMax <- max(recentDT$value)

p <- addLockdownDateTime(p)
addWeekendsDateTime(p)
```

Figure \@ref(fig:no2compare) shows the most recent mean daily values compared to previous years.

```{r no2compare, fig.cap="Nitrogen Dioxide levels, Southampton (daily mean)"}

plotDT <- no2dt[!is.na(value) & dayOfYear <= lubridate::today(), .(mean = mean(value)), keyby = .(dayOfYear, compareYear)]

# final plot - adds annotations
yMin <- min(plotDT$mean)
yMax <- max(plotDT$mean)

p <- compareYearsPlot(plotDT)
p <- addLockdownDate(p)
addWeekendsDate(p)
```

> Beware seasonal trends and weather effects


# Oxides of Nitrogen (nox)

```{r NoxSummary}
yLab <- "Oxides of Nitrogen (ug/m3)"
noxdt <- sotonAirDT[pollutant == "nox"]
```

Figure \@ref(fig:noxrecent) shows the most recent hourly data.

```{r noxrecent, fig.cap="Oxides of nitrogen levels, Southampton (hourly, recent)"}
recentDT <- noxdt[!is.na(value) & obsDate > myParams$recentCutDate]
p <- makeDotPlot(recentDT, 
                 xVar = "dateTimeUTC", 
                 yVar = "value", 
                 byVar = "site", 
                 yLab = yLab)

p <- p +
  scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap))

# final plot - adds annotations
yMin <- min(recentDT$value)
yMax <- max(recentDT$value)

p <- addLockdownDateTime(p)

addWeekendsDateTime(p)
```

Figure \@ref(fig:noxcompare) shows the most recent mean daily values compared to previous years.

```{r noxcompare, fig.cap="Oxides of nitrogen levels, Southampton (daily mean)"}

plotDT <- noxdt[!is.na(value) & dayOfYear <= lubridate::today(), .(mean = mean(value)), keyby = .(dayOfYear, compareYear)]

# final plot - adds annotations
yMin <- min(plotDT$mean)
yMax <- max(plotDT$mean)

p <- compareYearsPlot(plotDT)
p <- addLockdownDate(p)
addWeekendsDate(p)
```


# Sulphour Dioxide

```{r So2Summary}
yLab <- "Sulphour Dioxide (ug/m3)"
so2dt <- sotonAirDT[pollutant == "so2"]

```

Figure \@ref(fig:so2recent) shows the most recent hourly data.

```{r so2recent, fig.cap="Sulphour Dioxide levels, Southampton (hourly, recent)"}
recentDT <- so2dt[!is.na(value) & obsDate > myParams$recentCutDate]
p <- makeDotPlot(recentDT, 
                 xVar = "dateTimeUTC", 
                 yVar = "value", 
                 byVar = "site", 
                 yLab = yLab)

p <- p +
  scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap))

yMax <- max(recentDT$value)
yMin <- min(recentDT$value)
p <- addLockdownDateTime(p)
addWeekendsDateTime(p)
```

Figure \@ref(fig:so2compare) shows the most recent mean daily values compared to previous years.

```{r so2compare, fig.cap="Oxides of nitrogen levels, Southampton (daily mean)"}

plotDT <- so2dt[!is.na(value) & dayOfYear <= lubridate::today(), .(mean = mean(value)), keyby = .(dayOfYear, compareYear)]

# final plot - adds annotations
yMin <- min(plotDT$mean)
yMax <- max(plotDT$mean)

p <- compareYearsPlot(plotDT)
p <- addLockdownDate(p)
addWeekendsDate(p)
```

> Beware seasonal trends and weather effects

# Ozone


```{r o3Summary}
yLab <- "Ozone (ug/m3)"
o3dt <- sotonAirDT[pollutant == "o3"]
```

Figure \@ref(fig:03recent) shows the most recent hourly data.

```{r 03recent, fig.cap="03 levels, Southampton (hourly, recent)"}
recentDT <- o3dt[!is.na(value) & obsDate > myParams$recentCutDate]
p <- makeDotPlot(recentDT, 
                 xVar = "dateTimeUTC", 
                 yVar = "value", 
                 byVar = "site", 
                 yLab = yLab)

p <- p +
  scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap))

yMax <- max(recentDT$value)
yMin <- min(recentDT$value)
p <- addLockdownDateTime(p)
addWeekendsDateTime(p)
```

Figure \@ref(fig:o3compare) shows the most recent mean daily values compared to previous years.

```{r o3compare, fig.cap="Oxides of nitrogen levels, Southampton (daily mean)"}

plotDT <- o3dt[!is.na(value) & dayOfYear <= lubridate::today(), .(mean = mean(value)), keyby = .(dayOfYear, compareYear)]

# final plot - adds annotations
yMin <- min(plotDT$mean)
yMax <- max(plotDT$mean)

p <- compareYearsPlot(plotDT)
p <- addLockdownDate(p)
addWeekendsDate(p)
```


> Beware seasonal trends and weather effects

# PM 10

```{r pm10Summary}
yLab <- "PM 10 (ug/m3)"
pm10dt <- sotonAirDT[pollutant == "pm10"]

```

Figure \@ref(fig:pm10recent) shows the most recent hourly data.

```{r pm10recent, fig.cap="PM10 levels, Southampton (hourly, recent)"}
recentDT <- pm10dt[!is.na(value) & obsDate > myParams$recentCutDate]
p <- makeDotPlot(recentDT, 
                 xVar = "dateTimeUTC", 
                 yVar = "value", 
                 byVar = "site", 
                 yLab = yLab)

p <- p +
scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap))

yMax <- max(recentDT$value)
yMin <- min(recentDT$value)
p <- addLockdownDateTime(p)
addWeekendsDateTime(p)
```

Figure \@ref(fig:pm10compare) shows the most recent mean daily values compared to previous years.

```{r pm10compare, fig.cap="Oxides of nitrogen levels, Southampton (daily mean)"}

plotDT <- pm10dt[!is.na(value) & dayOfYear <= lubridate::today(), .(mean = mean(value)), keyby = .(dayOfYear, compareYear)]

# final plot - adds annotations
yMin <- min(plotDT$mean)
yMax <- max(plotDT$mean)

p <- compareYearsPlot(plotDT)
p <- addLockdownDate(p)
addWeekendsDate(p)
```

> Beware seasonal trends and weather effects

# PM 2.5

```{r pm25Summary}
yLab <- "PM 2.5 (ug/m3)"
pm25dt <- sotonAirDT[pollutant == "pm2.5"]

```

Figure \@ref(fig:pm25recent) shows the most recent hourly data.

```{r pm25recent, fig.cap="PM2.5 levels, Southampton (hourly, recent)"}
recentDT <- pm25dt[!is.na(value) & obsDate > myParams$recentCutDate]
p <- makeDotPlot(recentDT, 
                 xVar = "dateTimeUTC", 
                 yVar = "value", 
                 byVar = "site", 
                 yLab = yLab)

p <- p +
  scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap, "\nNB: There is no WHO PM2.5 hourly threshold"))

yMax <- max(recentDT$value)
yMin <- min(recentDT$value)
p <- addLockdownDateTime(p)
addWeekendsDateTime(p)
```

Figure \@ref(fig:pm25compare) shows the most recent mean daily values compared to previous years.

```{r pm25compare, fig.cap="Oxides of nitrogen levels, Southampton (daily mean)"}

plotDT <- pm25dt[!is.na(value) & dayOfYear <= lubridate::today(), .(mean = mean(value)), keyby = .(dayOfYear, compareYear)]

# final plot - adds annotations
yMin <- min(plotDT$mean)
yMax <- max(plotDT$mean)

p <- compareYearsPlot(plotDT)
p <- addLockdownDate(p)
addWeekendsDate(p)
```

> Beware seasonal trends and weather effects

# Annex

## Missing data

Several of these datasets suffer from missing data. This is visualised below.

```{r testNegNo2, fig.cap="Nitrogen Dioxide data availability and levels over time"}
# dt,xvar, yvar,fillVar, yLab
p <- makeTilePlot(no2dt, xVar = "dateTimeUTC", yVar = "site",
                  fillVar = "value",
                  yLab = yLab)

p
```

```{r testNegNox, fig.cap="Oxides of nitrogen data availability and levels over time"}

# dt,xvar, yvar,fillVar, yLab
p <- makeTilePlot(noxdt, xVar = "dateTimeUTC", yVar = "site",
                  fillVar = "value",
                  yLab = yLab)

p
```

```{r testNegSo2, fig.cap="Sulphour Dioxide data availability and levels over time"}

# dt,xvar, yvar,fillVar, yLab
p <- makeTilePlot(so2dt, xVar = "dateTimeUTC", yVar = "site",
                  fillVar = "value",
                  yLab = yLab)

p
```

```{r testNego3, fig.cap = "Availability and level of o3 data over time"}

p <- makeTilePlot(o3dt, xVar = "dateTimeUTC", yVar = "site",
                  fillVar = "value",
                  yLab = yLab)

p
```

```{r testNegPM10, fig.cap = "Availability and level of PM 10 data over time"}
p <- makeTilePlot(pm10dt, xVar = "dateTimeUTC", yVar = "site",
                  fillVar = "value",
                  yLab = yLab)

p
```

```{r testNegPM25, fig.cap = "Availability and level of PM 10 data over time"}

p <- makeTilePlot(pm25dt, xVar = "dateTimeUTC", yVar = "site",
                  fillVar = "value",
                  yLab = yLab)

p
```

# Runtime

Report generated using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform` (`r Sys.info()[3]`).

```{r check runtime}
t <- proc.time() - myParams$startTime

elapsed <- t[[3]]
```

Analysis completed in `r elapsed` seconds ( `r round(elapsed/60,2)` minutes).

R packages used:

 * data.table - [@data.table]
 * ggplot2 - [@ggplot2]
 * here - [@here]
 * kableExtra - [@kableExtra]
 * lubridate - [@lubridate]
 * skimr - [@skimr]
 * viridis - [@viridis]
            
# References

