---
params:
  title: ''
  subtitle: ''
  authors: ''
title: '`r params$title`'
subtitle: '`r params$subtitle`'
author: '`r params$authors`'
date: 'Last run at: `r getRunDateTime()`'
output:
  bookdown::html_document2:
    fig_caption: yes
    code_folding: hide
    self_contained: true # set to false if you want plots seperately for easy import to word https://bookdown.org/yihui/rmarkdown/html-document.html#document-dependencies
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: TRUE
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: yes
  bookdown::word_document2:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
    fig_width: 5
always_allow_html: yes
bibliography: '`r path.expand("~/bibliography.bib")`'
---

```{r knitrSetUp, include=FALSE}

# Set knitr options
knitr::opts_chunk$set(echo = FALSE,          # echo code so reader can see what is happening
                      warning = FALSE,
                      message = FALSE,
                      fig_caption = TRUE,
                      fig_height = 6,        # default, make it bigger to stretch vertical axis
                      fig_width = 8,
                      fig_width = 8,         # full width
                      tidy = TRUE)           # tidy up code in case echo = TRUE

```


```{r codeSetup, include=FALSE}

# Load Packages ----
rmdLibs <- c("ggplot2",
            "kableExtra",
            "openair",
            "skimr",
            "viridis")

dkUtils::loadLibraries(rmdLibs)

# Adjust knitr options if required
knitr::opts_chunk$set(echo = TRUE)

# Log compile time:
myParams$startTime <- proc.time()

# Parameters ----
# set xlim for plotly to reduce plot size & load speed
myParams$xlimMinDateTime <- lubridate::as_datetime("2018-01-01 00:00:00")
myParams$xlimMaxDateTime <- lubridate::as_datetime("2020-06-01 00:00:00")
myParams$xlimMinDate <- lubridate::as_date("2018-01-01")
myParams$xlimMaxDate <- lubridate::as_date("2020-06-01")

myParams$oneYearAgo <- lubridate::as_datetime(now() - (365*24*60*60))

# set values for annotations
myParams$lockDownStartDate <- as.Date("2020-03-24")
myParams$lockDownStartDateTime <- lubridate::as_datetime("2020-03-24 00:00:00")
myParams$lockDownEndDate <- lubridate::today()
myParams$lockDownEndDateTime <- lubridate::now()

myParams$recentCutDate <- as.Date("2020-03-01")

myParams$comparePlotCutDate <- as.Date("2020-02-01")

myParams$gamCap <- "Trend line = Generalized additive model (gam) with integrated smoothness estimation"
myParams$lockdownCap <- "\nColoured rectangle = UK covid lockdown to date"
myParams$weekendCap <- "\nShaded rectangle = weekends & public holidays"
myParams$noThresh <- "\nNo specified WHO threshold"

myParams$myAlpha <- 0.1
myParams$vLineAlpha <- 0.4
myParams$vLineCol <- "red" # http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/#a-colorblind-friendly-palette
myParams$myTextSize <- 4

# Functions ----
makeDotPlot <- function(dt, xVar, yVar, byVar, yLab){
  p <- ggplot2::ggplot(dt, aes(x = get(xVar), 
                               y = get(yVar),
                               colour = get(byVar)
                               #alpha = 1/100 # https://ggplot2.tidyverse.org/reference/geom_point.html
                               )
                       ) +
    geom_point(size = 1, shape = 2) + #get(byVar) # varies
    scale_colour_viridis_d(name = eval(byVar)) +
    guides(alpha = FALSE) + # remove alpha legend 
    labs(x = "Time",
         y = eval(yLab)) +  
    theme(legend.position="bottom") +
    guides(colour = guide_legend(nrow = 2)) # forces 2 rows to legend
  return(p)
}

makeTilePlot <- function(dt, xVar, yVar, fillVar, yLab){
  p <- ggplot2::ggplot(dt, aes(x = get(xVar), 
                               y = get(yVar),
                               fill = get(fillVar)
                               )
                       ) +
    geom_tile() +
    scale_fill_continuous(low = "green", high = "red", name = "Value") +
    labs(x = "Time",
         y = yLab) +  
    theme(legend.position="bottom")
  return(p)
}

compareYearsPlot <- function(dt, xVar, yVar, colVar){
  p <- ggplot2::ggplot(dt, aes(x = get(xVar), y = get(yVar), 
                               colour = as.factor(get(colVar)))) +
    geom_line() +
    scale_x_date(date_breaks = "7 day", date_labels =  "%a %d %b")  +
    theme(axis.text.x=element_text(angle=90, hjust=1)) +
    theme(legend.position="bottom") +
    scale_colour_discrete(name = "Period")
  return(p)
}

compareYearsDiffPlotDaily <- function(dt){
  baseDT <- dt[compareYear == "2017-2019", .(baseMean = mean(value),
                                             baseMedian = median(value)), 
               keyby = .(fixedDate, fixedDoW, compareYear)]
  testDT <- dt[compareYear == "2020", .(testMean = mean(value),
                                        testMedian = median(value)), 
               keyby = .(fixedDate, fixedDoW, compareYear, site)]
  
  setkey(baseDT, fixedDate, fixedDoW)
  setkey(baseDT, fixedDate, fixedDoW)
  
  plotDT <- baseDT[testDT] # auto drops non matches to 2020
  plotDT[, pcDiffMean := 100*(testMean - baseMean)/baseMean] # -ve value indicates lower
  plotDT[, pcDiffMedian:= 100*(testMedian - baseMedian)/baseMedian] # -ve value indicates lower
  plotDT[, pos := ifelse(pcDiffMean > 0 , "Pos", "Neg")] # want to colour the line sections - how?
  # final plot - adds annotations
  # use means for consistency with comparison plots where we use WHO thresholds (means)
  yMin <- min(plotDT$pcDiffMean)
  print(paste0("Max drop %:", round(yMin)))
  yMax <- max(plotDT$pcDiffMean)
  print(paste0("Max increase %:", round(yMax)))
  p <- ggplot2::ggplot(plotDT, aes(x = fixedDate, y = pcDiffMean 
                                   #color = pos, group=NA)
                                   )
                       ) +
    geom_step() +
    scale_x_date(date_breaks = "2 days", date_labels =  "%a %d %b")  +
    theme(axis.text.x=element_text(angle=90, hjust=1, size = 5)) +
    labs(x = "Date",
         y = "% difference 2020 vs 2017-2019",
         caption = paste0(myParams$lockdownCap, myParams$weekendCap)) +  
    theme(legend.position="bottom") +
    geom_hline(yintercept = 0, linetype = 3)
  
  p <- addLockdownDate(p, yMin, yMax)
  
  p <- addWeekendsDate(p, yMin, yMax)
  
  p <- p + facet_grid(site ~ .) +
    theme(strip.text.y.right = element_text(angle = 90))
  
  # p <- p + geom_hline(yintercept = yMin, linetype = 3) # dotted
  # p <- p + annotate("text", x = myParams$lockDownEndDate,
  #                   y = yMin,
  #                   label = yMin) # 
  # 
  # p <- p + geom_hline(yintercept = yMax, linetype = 3)
  # p <- p + annotate("text", x = myParams$lockDownEndDate,
  #                   y = yMax,
  #                   label = yMax) # 
  
  return(p)
}

compareYearsDiffPlotWeekly <- function(dt){
  dt[, weekNo := lubridate::week(fixedDate)]
  baseDT <- dt[compareYear == "2017-2019", .(baseMean = mean(value),
                                             baseMedian = median(value)), 
               keyby = .(weekNo, site)]
  testDT <- dt[compareYear == "2020", .(testMean = mean(value),
                                        testMedian = median(value)), 
               keyby = .(weekNo, site)]
  
  setkey(baseDT, weekNo, site)
  setkey(baseDT, weekNo, site)
  
  plotDT <- baseDT[testDT] # auto drops non matches to 2020
  plotDT[, pcDiffMean := 100*(testMean - baseMean)/baseMean] # -ve value indicates lower
  plotDT[, pcDiffMedian := 100*(testMedian - baseMedian)/baseMedian] # -ve value indicates lower
  
  # final plot - adds annotations
  # use means for consistency with comparison plots where we use WHO thresholds (means)
  yMin <- min(plotDT$pcDiffMean)
  yMax <- max(plotDT$pcDiffMean)
  p <- ggplot2::ggplot(plotDT, aes(x = weekNo, y = pcDiffMean)) +
    geom_step() +
    theme(axis.text.x=element_text(angle=90, hjust=1)) +
    labs(x = "Week",
         y = "% difference 2020 vs 2017-2019"
         ) +  
    theme(legend.position="bottom") +
    geom_hline(yintercept = 0,linetype = 3)
  # lubridate::week(as.Date("2020-03-24"))
  p <- p + annotate("rect", xmin = (lubridate::week(myParams$lockDownStartDate) - 0.1),
             xmax = (lubridate::week(myParams$lockDownEndDate) + 0.1), 
             ymin = yMin - 1, ymax = yMax + 1, 
             alpha = myParams$myAlpha, 
             fill = myParams$vLineCol, 
             colour = myParams$vLineCol)
  #p <- addLockdownDate(p, yMin, yMax)
  p <- p + facet_grid(site ~ .) +
    theme(strip.text.y.right = element_text(angle = 90))
  #p <- addWeekendsDate(p, yMin, yMax) + scale_x_date(date_breaks = "7 day",
   #                                             date_labels =  "%a %d %b",
    #                                            date_minor_breaks = "1 day")
  return(p)
}

profileTilePlot <- function(dt, yLab){
  p <- ggplot2::ggplot(dt, aes(x = obsDate,
                                     y = time, 
                                     fill = value)) +
    geom_tile() +
    scale_fill_continuous(low = "green", high = "red") +
    labs(x= "Date",
         y = "Time",
         fill = yLab) +
    theme(legend.position="bottom") +
    facet_grid(site ~ .)
  
  p <- p +
    scale_x_date(date_breaks = "2 day", date_labels =  "%a %d %b")  +
    theme(axis.text.x=element_text(angle=90, hjust=1)) +
    theme(strip.text.y.right = element_text(angle = 0, size = 7))
  # final plot - adds annotations
  return(p)
}

addLockdownDate <- function(p, yMin, yMax){
  # assumes p has x = obsDate
  # p <- p + annotate("text", x = myParams$lockDownStartDate, 
  #            y = yMax * 0.4, angle = 10,size = myParams$myTextSize,
  #            label = "UK covid lockdown to date", hjust = 0.5)
  p <- p + annotate("rect", xmin = myParams$lockDownStartDate,
             xmax = myParams$lockDownEndDate, 
             ymin = yMin-1, ymax = yMax+1, 
             alpha = myParams$myAlpha, 
             fill = myParams$vLineCol, 
             colour = myParams$vLineCol)
  return(p)
}

addLockdownDateTime <- function(p, yMin, yMax){
  # assumes p has x = obsDateTime
  # p <- p + annotate("text", x = myParams$lockDownStartDateTime, 
  #            y = yMax * 0.4, angle = 10,size = myParams$myTextSize,
  #            label = "UK covid lockdown to date", hjust = 0.5)
  p <- p + annotate("rect", xmin = myParams$lockDownStartDateTime,
             xmax = myParams$lockDownEndDateTime, 
             ymin = yMin-1, ymax = yMax+1, 
             alpha = myParams$myAlpha, 
             fill = myParams$vLineCol, 
             colour = myParams$vLineCol) 
    
  return(p)
}

# only makes sense to use these for x axis covering March onwards
myParams$weAlpha <- 0.3
myParams$weFill <- "grey50"
myParams$labelPos <- 0.9
addWeekendsDate <- function(p, yMin, yMax){
  p <- p + annotate("rect", xmin = as.Date("2020-03-07"),
                    xmax = as.Date("2020-03-09"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("rect", xmin = as.Date("2020-03-14"),
                    xmax = as.Date("2020-03-16"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("rect", xmin = as.Date("2020-03-21"),
                    xmax = as.Date("2020-03-23"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("rect", xmin = as.Date("2020-03-28"),
                    xmax = as.Date("2020-03-30"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("rect", xmin = as.Date("2020-04-04"),
                    xmax = as.Date("2020-04-06"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("rect", xmin = as.Date("2020-04-10"),
                    xmax = as.Date("2020-04-14"), # Easter
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("text", x = as.Date("2020-04-10"),
                    y = yMax*myParams$labelPos,
                    label = "Easter") # Easter
  p <- p + annotate("rect", xmin = as.Date("2020-04-18"),
                    xmax = as.Date("2020-04-20"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("rect", xmin = as.Date("2020-04-25"),
                    xmax = as.Date("2020-04-27"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  return(p)
}

addWeekendsDateTime <- function(p, yMin, yMax){
   p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-03-07 00:00:00"),
                    xmax = lubridate::as_datetime("2020-03-08 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-03-14 00:00:00"),
                    xmax = lubridate::as_datetime("2020-03-15 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-03-21 00:00:00"),
                    xmax = lubridate::as_datetime("2020-03-22 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-03-28 00:00:00"),
                    xmax = lubridate::as_datetime("2020-03-29 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-04-04 00:00:00"),
                    xmax = lubridate::as_datetime("2020-04-05 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill) 
  p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-04-10 00:00:00"),
                    xmax = lubridate::as_datetime("2020-04-13 23:59:59"), # Easter
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  p <- p + annotate("text", x = lubridate::as_datetime("2020-04-10 00:00:00"),
                    y = yMax*myParams$labelPos,
                    label = "Easter") # Easter
  p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-04-18 00:00:00"),
                    xmax = lubridate::as_datetime("2020-04-19 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
    p <- p + annotate("rect", xmin = lubridate::as_datetime("2020-04-25 00:00:00"),
                    xmax = lubridate::as_datetime("2020-04-26 23:59:59"),
                    ymin = yMin, ymax = yMax,
                    alpha = myParams$weAlpha, fill = myParams$weFill)
  return(p)
}
```

# About

## Code

Source:

 * https://github.com/CfSOtago/airQual

History:

 * https://github.com/CfSOtago/airQual/commits/master

## Comments and feedback

If you wish to comment please open an issue:
 
 * https://github.com/CfSOtago/airQual/issues

## Citation

If you wish to refer to any of the material from this report please cite as:

 * Anderson, B., (`r format(Sys.time(), format = "%Y")`) `r params$title`: `r params$subtitle` , [Sustainable Energy Research Group](http://www.energy.soton.ac.uk), University of Southampton: Southampton, UK.

Report circulation:

 * Public
 
This work is (c) `r format(Sys.time(), format = "%Y")` the University of Southampton and is part of a collection of [air quality](https://cfsotago.github.io/airQual/) data analyses.
 
# Introduction

```{r prepData}
sotonAirDT[, obsDate := lubridate::date(dateTimeUTC)]
sotonAirDT[, year := lubridate::year(dateTimeUTC)]
sotonAirDT[, origDoW := lubridate::wday(dateTimeUTC, label = TRUE)]
sotonAirDT[, month := lubridate::month(obsDate)]

sotonAirDT[, site := ifelse(site == "Southampton A33", "Southampton A33\n(via AURN)", site)]
sotonAirDT[, site := ifelse(site == "Southampton Centre", "Southampton Centre\n(via AURN)", site)]

extractDT <- sotonAirDT[!is.na(value)] # leave out 2016 so we compare with previous 3 years

# this is such a kludge
extractDT[, decimalDate := lubridate::decimal_date(obsDate)] # gives year.% of year

# set to 2020 'dates'
extractDT[, date2020 := lubridate::as_date(lubridate::date_decimal(2020 + (decimalDate - year)))] # sets 'year' portion to 2020 so the lockdown annotation works
extractDT[, day2020 := lubridate::wday(date2020, label = TRUE)] # 

# 2020 Jan 1st = Weds
dt2020 <- extractDT[year == 2020] 
dt2020[, fixedDate := obsDate] # no need to change
dt2020[, fixedDoW := lubridate::wday(fixedDate,label = TRUE)]
# table(dt2020$origDoW, dt2020$fixedDoW)
# head(dt2020[origDoW != fixedDoW])

# shift to the closest aligning day
# 2019 Jan 1st = Tues
dt2019 <- extractDT[year == 2019] 
dt2019[, fixedDate := date2020 -1]
dt2019[, fixedDoW := lubridate::wday(fixedDate,label = TRUE)]
# table(dt2019$origDoW, dt2019$fixedDoW)
# head(dt2019[origDoW != fixedDoW])

# 2018 Jan 1st = Mon
dt2018 <- extractDT[year == 2018] 
dt2018[, fixedDate := date2020 - 2]
dt2018[, fixedDoW := lubridate::wday(fixedDate,label = TRUE)]
# table(dt2018$origDoW, dt2018$fixedDoW)
# head(dt2018[origDoW != fixedDoW])

# 2017 Jan 1st = Sat
dt2017 <- extractDT[year == 2017] 
dt2017[, fixedDate := date2020 - 3]
dt2017[, fixedDoW := lubridate::wday(fixedDate,label = TRUE)]
# table(dt2017$origDoW, dt2017$fixedDoW)
# head(dt2017[origDoW != fixedDoW])

fixedDT <- rbind(dt2017, dt2018, dt2019, dt2020) # leave out 2016 for now

fixedDT[, fixedDate := lubridate::as_date(fixedDate)]
fixedDT[, fixedDoW := lubridate::wday(fixedDate,label = TRUE)]


fixedDT[, compareYear := ifelse(year == 2020, "2020",
                              "2017-2019")]

# these should match 
#table(fixedDT$origDoW, fixedDT$fixedDoW)

lastHA <- max(fixedDT[source == "hantsAir"]$dateTimeUTC)
diffHA <- lubridate::now() - lastHA
lastAURN <- max(fixedDT[source == "AURN"]$dateTimeUTC)
diffAURN <- lubridate::now() - lastAURN
```

Data for Southampton downloaded from :

 * http://www.hantsair.org.uk/hampshire/asp/Bulletin.asp?la=Southampton (see also https://www.southampton.gov.uk/environmental-issues/pollution/air-quality/);
 * https://uk-air.defra.gov.uk/networks/network-info?view=aurn
 
Southampton City Council collects various forms of air quality data at the sites shown in Table \@ref(tab:showSites). The data is available in raw form from http://www.hantsair.org.uk/hampshire/asp/Bulletin.asp?la=Southampton&bulletin=daily&site=SH5.

Some of these sites feed data to [AURN](https://uk-air.defra.gov.uk/networks/network-info?view=aurn). The data that goes via AURN is [ratified](https://uk-air.defra.gov.uk/assets/documents/Data_Validation_and_Ratification_Process_Apr_2017.pdf) to check for outliers and instrument/measurement error. AURN data less than six months old has not undergone this process. AURN data is (c) Crown 2020 copyright Defra and available for re-use via https://uk-air.defra.gov.uk, licenced under the [Open Government Licence](http://www.nationalarchives.gov.uk/doc/open-government-licence/version/2/) (OGL).

In this report we use data from the following sources:

 * http://www.hantsair.org.uk/hampshire/asp/Bulletin.asp?la=Southampton last updated at `r lastHA`;
 * https://uk-air.defra.gov.uk/networks/network-info?view=aurn last updated at `r lastAURN`.

Table \@ref(tab:showSites) shows the available sites and sources. Note that some of the non-AURN sites appear to have stopped updating recently. For a detailed analysis of recent missing data see Section \@ref(annexMissing).

```{r showSites}
t <- fixedDT[!is.na(value),.(nObs = .N, firstData = min(dateTimeUTC), latestData = max(dateTimeUTC),
           nMeasures = uniqueN(pollutant)), keyby = .(site, source)]

kableExtra::kable(t, caption = "Sites, data source and number of valid observations. note that measures includes wind speed and direction in the AURN sourced data",
                  digits = 2) %>%
  kable_styling()
```

To avoid confusion and 'double counting', in the remainder of the analysis we replace the Southampton AURN site data with the data for the same site sourced via AURN as shown in Table \@ref(tab:selectFinalSites). This has the disadvantage that the data is slightly less up to date (see Table \@ref(tab:showSites)). As will be explained below in the comparative analysis we will use only the AURN data to avoid missing data issues.

```{r selectFinalSites}
fixedDT <- fixedDT[!(site %like% "AURN site")]

t <- fixedDT[!is.na(value),.(nObs = .N,
           nPollutants = uniqueN(pollutant),
           lastDate = max(dateTimeUTC)), keyby = .(site, source)]

kableExtra::kable(t, caption = "Sites, data source and number of valid observations",
                  digits = 2) %>%
  kable_styling()
```

We use this data to compare:

 * pre and during-lockdown air quality measures
 * air quality measures during lockdown 2020 with average measures for the same time periods in the preceding 3 years (2017-2019)

It should be noted that air pollution levels in any given period of time are highly dependent on the prevailing meteorological conditions. As a result it can be very difficult to disentangle the affects of a reduction in source strength from the affects of local surface conditions. This is abundantly clear in the analysis which follows given that the Easter weekend was forecast to have [very high import of pollution from Europe](https://airqualitynews.com/2020/04/07/people-at-risk-from-coronavirus-warned-with-very-high-air-pollution-episode-predicted-for-uk/) and that the wind direction and speed was highly variable across the lockdown period (see Figure \@ref(fig:recentWind)).

Further, air quality is not wholly driven by sources that lockdown might suppress and indeed that suppression may lead to rebound affects. For example we might expect more emissions due to increased domestic heating during cooler lockdown periods. As a result the analysis presented below must be considered a preliminary ‘before meteorological adjustment’ and ‘before controlling for other sources’ analysis of the affect of lockdown on air quality in Southampton.


For much more detailed analysis see a longer and very messy [data report](https://cfsotago.github.io/airQual/sccAirQualExplore_Exploring%20the%20SSC%20and%20AURN%20data.html).

# WHO air quality thresholds

A number of the following plots show the relevant WHO air quality thresholds and limits. These are taken from:

 * https://www.who.int/news-room/fact-sheets/detail/ambient-(outdoor)-air-quality-and-health

# Nitrogen Dioxide (no2)


```{r No2Summary}
yLab <- "Nitrogen Dioxide (ug/m3)"
no2dt <- fixedDT[pollutant == "no2"]
```

Figure \@ref(fig:no2recent) shows the most recent hourly data.

```{r no2recent, fig.cap="Nitrogen Dioxide levels, Southampton (hourly, recent)"}
recentDT <- no2dt[obsDate > myParams$recentCutDate]
p <- makeDotPlot(recentDT, 
                 xVar = "dateTimeUTC", 
                 yVar = "value", 
                 byVar = "site", 
                 yLab = yLab)

p <- p +
  scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1))

p <- p + geom_hline(yintercept = myParams$hourlyNo2Threshold_WHO) +
  labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap,
                        "\nReference line = WHO hourly threshold (", myParams$hourlyNo2Threshold_WHO, ")")
       )

# final plot - adds annotations
yMin <- min(recentDT$value)
yMax <- max(recentDT$value)

p <- addLockdownDateTime(p, yMin, yMax)
addWeekendsDateTime(p,yMin, yMax) +
  guides(colour=guide_legend(ncol=2))

```

Figure \@ref(fig:no2recentProfile) shows the most recent hourly data by date and time of day.

```{r no2recentProfile, fig.cap="Nitrogen Dioxide levels, Southampton (hourly, recent)"}
recentDT[, time := hms::as_hms(dateTimeUTC)]
yMin <- min(recentDT$time)
yMax <- max(recentDT$time)
p <- profileTilePlot(recentDT, yLab)
p <- addLockdownDate(p, yMin, yMax)
addWeekendsDate(p, yMin, yMax) + 
  labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap))
```

Figure \@ref(fig:no2compare) shows the most recent mean daily values compared to previous years for thw two AURN sites which do not have missing data. We have shifted the dates for the comparison years to ensure that weekdays and weekends line up. Note that this plot shows daily means with no indications of variance. Visible differences are therefore purely indicative at this stage.

```{r no2compare, fig.cap="Comparative Nitrogen Dioxide levels 2020 vs 2017-2019, Southampton (daily mean)"}
plotDT <- no2dt[site %like% "via AURN" & fixedDate <= lubridate::today() & 
                  fixedDate >= myParams$comparePlotCut, 
                .(meanVal = mean(value),
                  medianVal = median(value),
                  nSites = uniqueN(site)), 
                keyby = .(fixedDate, compareYear, site)]

# final plot - adds annotations
yMin <- min(plotDT$meanVal)
yMax <- max(plotDT$meanVal)

p <- compareYearsPlot(plotDT, xVar = "fixedDate", 
                      yVar = "meanVal",
                      colVar = "compareYear")
  
p <- addLockdownDate(p, yMin, yMax) +
  labs(x = "Date",
         y = "Daily mean",
       caption = paste0(myParams$lockdownCap, myParams$weekendCap, myParams$noThresh))

p <- addWeekendsDate(p, yMin, yMax) + scale_x_date(date_breaks = "7 day",
                                  date_labels =  "%a %d %b",
                                  date_minor_breaks = "1 day")

p + facet_grid(site ~ .) +
  theme(strip.text.y.right = element_text(angle = 90))
```

Figure \@ref(fig:no2pcDiffcompareDay) and \@ref(fig:no2pcDiffcompareWeek) show the % difference between the daily  means for 2020 vs 2017-2019 (reference period). In both cases we can see that NO2 levels in 2020 were generally _already_ lower than the reference period yet are _not_ consistently lower even during the lockdown period. The affects of covid lockdown are not clear cut...

```{r no2pcDiffcompareDay, fig.cap="Percentage difference in daily mean Nitrogen Dioxide levels 2020 vs 2017-2019, Southampton"}

testDate <- myParams$comparePlotCut
#testDate <- as.Date("2020-03-21")
compareYearsDiffPlotDaily(no2dt[site %like% "via AURN" & fixedDate >= testDate]) +
    labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap))
```

```{r no2pcDiffcompareWeek, fig.cap="Percentage difference in weekly mean Nitrogen Dioxide levels 2020 vs 2017-2019, Southampton"}
compareYearsDiffPlotWeekly(no2dt[site %like% "via AURN" & fixedDate >= myParams$comparePlotCut]) +
  labs(caption = paste0(myParams$lockdownCap))
```

> Beware seasonal trends and meteorological affects


# Oxides of Nitrogen (nox)

```{r NoxSummary}
yLab <- "Oxides of Nitrogen (ug/m3)"
noxdt <- fixedDT[pollutant == "nox"]
```

Figure \@ref(fig:noxrecent) shows the most recent hourly data.

```{r noxrecent, fig.cap="Oxides of nitrogen levels, Southampton (hourly, recent)"}
recentDT <- noxdt[!is.na(value) & obsDate > myParams$recentCutDate]
p <- makeDotPlot(recentDT, 
                 xVar = "dateTimeUTC", 
                 yVar = "value", 
                 byVar = "site", 
                 yLab = yLab)

p <- p +
  scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap,myParams$noThresh))

# final plot - adds annotations
yMin <- min(recentDT$value)
yMax <- max(recentDT$value)

p <- addLockdownDateTime(p, yMin, yMax)

addWeekendsDateTime(p, yMin, yMax)
```

Figure \@ref(fig:noxrecentProfile) shows the most recent hourly data by date and time of day.

```{r noxrecentProfile, fig.cap="Oxides of nitrogen levels, Southampton (hourly, recent)"}
recentDT[, time := hms::as_hms(dateTimeUTC)]
yMin <- min(recentDT$time)
yMax <- max(recentDT$time)
p <- profileTilePlot(recentDT, yLab)
addWeekendsDate(p, yMin, yMax) + 
  labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap))

```

Figure \@ref(fig:noxcompare) shows the most recent mean daily values compared to previous years for the two AURN sites.

```{r noxcompare, fig.cap="Oxides of nitrogen levels, Southampton (daily mean)"}

plotDT <- noxdt[site %like% "via AURN" & fixedDate <= lubridate::today() & 
                  fixedDate >= myParams$comparePlotCut , 
                .(meanVal = mean(value),
                  medianVal = median(value),
                  nSites = uniqueN(site)), 
                keyby = .(fixedDate, compareYear, site)]

# final plot - adds annotations
yMin <- min(plotDT$meanVal)
yMax <- max(plotDT$meanVal)

p <- compareYearsPlot(plotDT, xVar = "fixedDate", 
                      yVar = "meanVal",
                      colVar = "compareYear")
p <- addLockdownDate(p, yMin, yMax) +
  labs(x = "Date", y = "Daily mean", 
       caption = paste0(myParams$lockdownCap, myParams$weekendCap,myParams$noThresh))
p <- addWeekendsDate(p, yMin, yMax)

p + facet_grid(site ~ .) +
  theme(strip.text.y.right = element_text(angle = 90))
```

Figure \@ref(fig:noxpcDiffcompareDay) and \@ref(fig:noxpcDiffcompareWeek) show the % difference between the daily and weekly means for 2020 vs 2017-2019 (reference period).

```{r noxpcDiffcompareDay, fig.cap="% difference in daily mean Oxides of Nitrogen levels 2020 vs 2017-2019, Southampton"}

compareYearsDiffPlotDaily(noxdt[site %like% "via AURN" & fixedDate >= myParams$comparePlotCut]) +
    labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap))

```

```{r noxpcDiffcompareWeek, fig.cap="% difference in weekly mean Oxides of Nitrogen levels 2020 vs 2017-2019, Southampton"}
compareYearsDiffPlotWeekly(noxdt[site %like% "via AURN" & fixedDate >= myParams$comparePlotCut]) +
  labs(caption = paste0(myParams$lockdownCap))
```

# Sulphour Dioxide

```{r So2Summary}
yLab <- "Sulphour Dioxide (ug/m3)"
so2dt <- fixedDT[pollutant == "so2"]

```

Figure \@ref(fig:so2recent) shows the most recent hourly data.

```{r so2recent, fig.cap="Sulphour Dioxide levels, Southampton (hourly, recent)"}
recentDT <- so2dt[!is.na(value) & obsDate > myParams$recentCutDate]
p <- makeDotPlot(recentDT, 
                 xVar = "dateTimeUTC", 
                 yVar = "value", 
                 byVar = "site", 
                 yLab = yLab)

p <- p +
  scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap,myParams$noThresh))

yMax <- max(recentDT$value)
yMin <- min(recentDT$value)
p <- addLockdownDateTime(p, yMin, yMax)
addWeekendsDateTime(p, yMin, yMax)
```

Figure \@ref(fig:so2recentProfile) shows the most recent hourly data by date and time of day and time of day.

```{r so2recentProfile, fig.cap="Sulphour Dioxide levels, Southampton (hourly, recent)"}
recentDT[, time := hms::as_hms(dateTimeUTC)]

yMin <- min(recentDT$time)
yMax <- max(recentDT$time)
p <- profileTilePlot(recentDT, yLab)
addWeekendsDate(p, yMin, yMax) + 
  labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap))
```


Figure \@ref(fig:so2compare) shows the most recent mean daily values compared to previous years.

```{r so2compare, fig.cap="Sulphour dioxide levels, Southampton (daily mean)"}

plotDT <- so2dt[site %like% "via AURN" & fixedDate <= lubridate::today() & 
                  fixedDate >= myParams$comparePlotCut , 
                .(meanVal = mean(value),
                  medianVal = median(value),
                  nSites = uniqueN(site)), 
                keyby = .(fixedDate, compareYear, site)]

# final plot - adds annotations
yMin <- min(plotDT$mean)
yMax <- max(plotDT$mean)

p <- compareYearsPlot(plotDT, xVar = "fixedDate", 
                      yVar = "meanVal",
                      colVar = "compareYear")
p <- addLockdownDate(p, yMin, yMax) +
  geom_hline(yintercept = myParams$dailySo2Threshold_WHO) +
  labs(x = "Date", y = "Daily mean", 
       caption = paste0(myParams$lockdownCap, myParams$weekendCap,
                        "\nReference line = WHO daily threshold (", myParams$dailySo2Threshold_WHO, ")")
       )
p <- addWeekendsDate(p, yMin, yMax)

p + facet_grid(site ~ .) +
  theme(strip.text.y.right = element_text(angle = 90))
```


Figure \@ref(fig:so2pcDiffcompareDay) and \@ref(fig:so2pcDiffcompareWeek) show the % difference between the daily and weekly means for 2020 vs 2017-2019 (reference period).

```{r so2pcDiffcompareDay, fig.cap="% difference in daily mean Sulphour Dioxide levels 2020 vs 2017-2019, Southampton"}

compareYearsDiffPlotDaily(so2dt[site %like% "via AURN" & fixedDate >= myParams$comparePlotCut]) +
    labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap))
```

```{r so2pcDiffcompareWeek, fig.cap="% difference in weekly mean Sulphour Dioxide levels 2020 vs 2017-2019, Southampton"}
compareYearsDiffPlotWeekly(so2dt[site %like% "via AURN" & fixedDate >= myParams$comparePlotCut]) +
  labs(caption = paste0(myParams$lockdownCap))
```

> Beware seasonal trends and meteorological affects

# Ozone


```{r o3Summary}
yLab <- "Ozone (ug/m3)"
o3dt <- fixedDT[pollutant == "o3"]
```

Figure \@ref(fig:03recent) shows the most recent hourly data.

```{r 03recent, fig.cap="03 levels, Southampton (hourly, recent)"}
recentDT <- o3dt[!is.na(value) & obsDate > myParams$recentCutDate]
p <- makeDotPlot(recentDT, 
                 xVar = "dateTimeUTC", 
                 yVar = "value", 
                 byVar = "site", 
                 yLab = yLab)

p <- p +
  scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap,myParams$noThresh))

yMax <- max(recentDT$value)
yMin <- min(recentDT$value)
p <- addLockdownDateTime(p, yMin, yMax)
addWeekendsDateTime(p, yMin, yMax)
```

Figure \@ref(fig:o3recentProfile) shows the most recent hourly data by date and time of day.

```{r o3recentProfile, fig.cap="Ozone levels, Southampton (hourly, recent)"}
recentDT[, time := hms::as_hms(dateTimeUTC)]

yMin <- min(recentDT$time)
yMax <- max(recentDT$time)
p <- profileTilePlot(recentDT, yLab)
addWeekendsDate(p, yMin, yMax) + 
  labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap))
```


Figure \@ref(fig:o3compare) shows the most recent mean daily values compared to previous years.

```{r o3compare, fig.cap="Ozone levels, Southampton (daily mean)"}

plotDT <- o3dt[site %like% "via AURN" & fixedDate <= lubridate::today() & 
                  fixedDate >= myParams$comparePlotCut , 
                .(meanVal = mean(value),
                  medianVal = median(value),
                  nSites = uniqueN(site)), 
                keyby = .(fixedDate, compareYear, site)]

# final plot - adds annotations
yMin <- min(plotDT$mean)
yMax <- max(plotDT$mean)

p <- compareYearsPlot(plotDT, xVar = "fixedDate", 
                      yVar = "meanVal",
                      colVar = "compareYear")
p <- addLockdownDate(p, yMin, yMax) +
  geom_hline(yintercept = myParams$dailyO3Threshold_WHO) +
  labs(x = "Date", y = "Daily mean", 
       caption = paste0(myParams$lockdownCap, myParams$weekendCap,
                        "\nReference line = WHO daily threshold (", 
                               myParams$dailyO3Threshold_WHO, ")"
                        )
  )
p <- addWeekendsDate(p, yMin, yMax)
p + facet_grid(site ~ .) +
  theme(strip.text.y.right = element_text(angle = 90))
```


Figure \@ref(fig:o3pcDiffcompareDay) and \@ref(fig:o3pcDiffcompareWeek) show the % difference between the daily and weekly means for 2020 vs 2017-2019 (reference period).

```{r o3pcDiffcompareDay, fig.cap="% difference in daily mean Ozone levels 2020 vs 2017-2019, Southampton"}

compareYearsDiffPlotDaily(o3dt[site %like% "via AURN" & fixedDate >= myParams$comparePlotCut]) +
    labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap))

```

```{r o3pcDiffcompareWeek, fig.cap="% difference in weekly mean Ozone levels 2020 vs 2017-2019, Southampton"}

compareYearsDiffPlotWeekly(no2dt[site %like% "via AURN" & fixedDate >= myParams$comparePlotCut]) +
  labs(caption = paste0(myParams$lockdownCap))
```

> Beware seasonal trends and meteorological affects

# PM 10

```{r pm10Summary}
yLab <- "PM 10 (ug/m3)"
pm10dt <- fixedDT[pollutant == "pm10"]

```

Figure \@ref(fig:pm10recent) shows the most recent hourly data.

```{r pm10recent, fig.cap="PM10 levels, Southampton (hourly, recent)"}
recentDT <- pm10dt[!is.na(value) & obsDate > myParams$recentCutDate]
p <- makeDotPlot(recentDT, 
                 xVar = "dateTimeUTC", 
                 yVar = "value", 
                 byVar = "site", 
                 yLab = yLab)

p <- p +
scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap,myParams$noThresh))

yMax <- max(recentDT$value)
yMin <- min(recentDT$value)
p <- addLockdownDateTime(p, yMin, yMax)
addWeekendsDateTime(p, yMin, yMax)
```

Figure \@ref(fig:pm10recentProfile) shows the most recent hourly data by date and time of day.

```{r pm10recentProfile, fig.cap="PM10 levels, Southampton (hourly, recent)"}
recentDT[, time := hms::as_hms(dateTimeUTC)]

yMin <- min(recentDT$time)
yMax <- max(recentDT$time)
p <- profileTilePlot(recentDT, yLab)
addWeekendsDate(p, yMin, yMax) + 
  labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap))
```


Figure \@ref(fig:pm10compare) shows the most recent mean daily values compared to previous years.

```{r pm10compare, fig.cap="PM10 levels, Southampton (daily mean)"}

plotDT <- pm10dt[site %like% "via AURN" & fixedDate <= lubridate::today() & 
                  fixedDate >= myParams$comparePlotCut , 
                .(meanVal = mean(value),
                  medianVal = median(value),
                  nSites = uniqueN(site)), 
                keyby = .(fixedDate, compareYear, site)]

# final plot - adds annotations
yMin <- min(plotDT$mean)
yMax <- max(plotDT$mean)

p <- compareYearsPlot(plotDT, xVar = "fixedDate", 
                      yVar = "meanVal",
                      colVar = "compareYear")
p <- addLockdownDate(p, yMin, yMax) +
  geom_hline(yintercept = myParams$dailyPm10Threshold_WHO) +
  labs(x = "Date", y = "Daily mean", 
       caption = paste0(myParams$lockdownCap, myParams$weekendCap,
                        "\nReference line = WHO daily threshold (", myParams$dailyPm10Threshold_WHO, ")")
       )
p <- addWeekendsDate(p, yMin, yMax)
p + facet_grid(site ~ .) +
  theme(strip.text.y.right = element_text(angle = 90))
```


Figure \@ref(fig:pm10pcDiffcompareDay) and \@ref(fig:pm10pcDiffcompareWeek) show the % difference between the daily and weekly means for 2020 vs 2017-2019 (reference period).

```{r pm10pcDiffcompareDay, fig.cap="% difference in daily mean PM10 levels 2020 vs 2017-2019, Southampton"}

compareYearsDiffPlotDaily(pm10dt[site %like% "via AURN" & fixedDate >= myParams$comparePlotCut]) +
    labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap))

```

```{r pm10pcDiffcompareWeek, fig.cap="% difference in weekly mean PM10 levels 2020 vs 2017-2019, Southampton"}

compareYearsDiffPlotWeekly(pm10dt[site %like% "via AURN" & fixedDate >= myParams$comparePlotCut]) +
  labs(caption = paste0(myParams$lockdownCap))
```

> Beware seasonal trends and meteorological affects

# PM 2.5

```{r pm25Summary}
yLab <- "PM 2.5 (ug/m3)"
pm25dt <- fixedDT[pollutant == "pm2.5"]

```

Figure \@ref(fig:pm25recent) shows the most recent hourly data.

```{r pm25recent, fig.cap="PM2.5 levels, Southampton (hourly, recent)"}
recentDT <- pm25dt[!is.na(value) & obsDate > myParams$recentCutDate]
p <- makeDotPlot(recentDT, 
                 xVar = "dateTimeUTC", 
                 yVar = "value", 
                 byVar = "site", 
                 yLab = yLab)

p <- p +
  scale_x_datetime(date_breaks = "2 day", date_labels =  "%a %d %b")  +
  theme(axis.text.x=element_text(angle=90, hjust=1)) +
  labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap, myParams$noThresh))

yMax <- max(recentDT$value)
yMin <- min(recentDT$value)
p <- addLockdownDateTime(p, yMin, yMax)
addWeekendsDateTime(p, yMin, yMax)
```

Figure \@ref(fig:pm25recentProfile) shows the most recent hourly data by date and time of day.

```{r pm25recentProfile, fig.cap="PM2.5 levels, Southampton (hourly, recent)"}
recentDT[, time := hms::as_hms(dateTimeUTC)]

yMin <- min(recentDT$time)
yMax <- max(recentDT$time)
p <- profileTilePlot(recentDT, yLab)
addWeekendsDate(p, yMin, yMax) + 
  labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap))
```

Figure \@ref(fig:pm25compare) shows the most recent mean daily values compared to previous years.

```{r pm25compare, fig.cap="PM2.5 levels, Southampton (daily mean)"}

plotDT <- pm25dt[site %like% "via AURN" & fixedDate <= lubridate::today() & 
                  fixedDate >= myParams$comparePlotCut , 
                .(meanVal = mean(value),
                  medianVal = median(value),
                  nSites = uniqueN(site)), 
                keyby = .(fixedDate, compareYear, site)]

# final plot - adds annotations
yMin <- min(plotDT$mean)
yMax <- max(plotDT$mean)

p <- compareYearsPlot(plotDT, xVar = "fixedDate", 
                      yVar = "meanVal",
                      colVar = "compareYear")
p <- addLockdownDate(p, yMin, yMax) +
  geom_hline(yintercept = myParams$dailyPm2.5Threshold_WHO) +
  labs(x = "Date", y = "Daily mean", 
       caption = paste0(myParams$lockdownCap, myParams$weekendCap,
                        "\nReference line = WHO daily threshold (", myParams$dailyPm2.5Threshold_WHO,")")
       )
p <- addWeekendsDate(p, yMin, yMax)
p + facet_grid(site ~ .) +
  theme(strip.text.y.right = element_text(angle = 90))
```


Figure \@ref(fig:pm25pcDiffcompareDay) and \@ref(fig:pm25pcDiffcompareWeek) show the % difference between the daily and weekly means for 2020 vs 2017-2019 (reference period).

```{r pm25pcDiffcompareDay, fig.cap="% difference in daily mean PM2.5 levels 2020 vs 2017-2019, Southampton"}

compareYearsDiffPlotDaily(pm25dt[site %like% "via AURN" & fixedDate >= myParams$comparePlotCut]) +
    labs(caption = paste0(myParams$lockdownCap, myParams$weekendCap))

```

```{r pm25pcDiffcompareWeek, fig.cap="% difference in weekly mean PM2.5 levels 2020 vs 2017-2019, Southampton"}

compareYearsDiffPlotWeekly(pm25dt[site %like% "via AURN" & fixedDate >= myParams$comparePlotCut]) +
  labs(caption = paste0(myParams$lockdownCap))
```

> Beware seasonal trends and meteorological affects

# Wind direction and speed

As noted above, air pollution levels in any given time period are highly dependent on the prevailing meteorological conditions.

Figure \@ref(fig:recentWind) shows the wind direction and speed over the period of lockdown and can be compared with the equivalent pollutant level plots above such as Figure \@ref(fig:no2recent).

```{r recentWind, fig.cap="Wind direction and speed in Southampton since 23rd March 2020"}
# windDT[, .(mean = mean(wd)), keyby = .(site)] # they're identical across AURN sites
windDirDT <- fixedDT[pollutant == "wd" & site %like% "A33"]
windDirDT[, `:=`(wd, value)]
setkey(windDirDT, dateTimeUTC, site, source)
windSpeedDT <- fixedDT[pollutant == "ws" & site %like% "A33"]
windSpeedDT[, `:=`(ws, value)]
setkey(windSpeedDT, dateTimeUTC, site, source)

windDT <- windSpeedDT[windDirDT]
windDT[, `:=`(rTime, hms::as_hms(dateTimeUTC))]
p <- ggplot2::ggplot(windDT[obsDate > as.Date("2020-03-23")], aes(x = dateTimeUTC, y = ws, angle = -wd + 90, 
                                                                  colour = ws)) + geom_text(label = "→") + theme(legend.position = "bottom") + guides(colour = guide_legend(title = "Wind speed")) + 
  scale_color_continuous(high = "#132B43", low = "#56B1F7") # normal blue reversed


yMin <- min(windDT[obsDate > as.Date("2020-03-23")]$ws)
yMax <- max(windDT[obsDate > as.Date("2020-03-23")]$ws)
p <- addWeekendsDateTime(p, yMin, yMax)
#p <- addLockdownDateTime(p, yMin, yMax)
p <- p + labs(y = "Wind speed", 
         x = "Time", 
         caption = paste0(myParams$weekendCap)) + 
  theme(axis.text.x=element_text(angle=90, hjust=1, size = 9))
p +
  xlim(lubridate::as_datetime("2020-03-23 23:59:59"), 
       NA)  # do this last otherwise adding the weekends takes the plot back to the earliest weekend we annotate
```

Figure \@ref(fig:recentWindRose) shows a [windrose](https://www.rdocumentation.org/packages/openair/versions/2.7-2/topics/windRose) for each of the periods of low/high pollutant levels visible in Figure \@ref(fig:no2pcDiffcompareDay):

 * 26 March - 4 April (lower NO2)
 * 7 April - 12 April (higher NO2)
 * 16 April - 23 April (lower NO2)

The windroses indicate the direction the prevailing wind was blowing from and the colour of the 'paddles' indicates the strength while the length of the paddles indicates the proportion of observations. As we can see there are clear differences in the wind conditions which correlate with the pollution patterns observed:

 * the first period with low NO2 was dominated by north-north easterly winds (likely to bring city and motorway air); 
 * the second period when NO2 and particulates were high was dominated by low speed south easterly winds (bringing continental air);
 * the third period when NO2 was low was again dominated by north easterly winds.

```{r recentWindRose, fig.cap="Wind rose for Southampton sites since 23rd March 2020"}

sotonAirDT[, aqPeriod := ifelse(obsDate >= as.Date("2020-03-26") & 
                                  obsDate <= as.Date("2020-04-04"),
                               "Period 1 - Low: 26/3 - 4/4", NA)]
sotonAirDT[, aqPeriod := ifelse(obsDate >= as.Date("2020-04-07") & 
                                  obsDate <= as.Date("2020-04-12"),
                               "Period 2 - High: 7/4 - 12/4", aqPeriod)]
sotonAirDT[, aqPeriod := ifelse(obsDate >= as.Date("2020-04-16") & 
                                  obsDate <= as.Date("2020-04-23"),
                               "Period 3 - Low: 16/4 - 23/4", aqPeriod)]

plotDT <- sotonAirDT[!is.na(aqPeriod) & (pollutant == "ws" | pollutant == "wd") & site %like% "A33"]

t <- plotDT[, .(start = min(dateTimeUTC),
           end = max(dateTimeUTC)), keyby = .(aqPeriod)]

kableExtra::kable(t, caption = "Check period start/end times") %>%
  kable_styling()
  

# make a dt openair will accept
wdDT <- plotDT[pollutant == "wd", .(dateTimeUTC, site, wd = value, aqPeriod)]
setkey(wdDT, dateTimeUTC, site, aqPeriod)
wsDT <- plotDT[pollutant == "ws", .(dateTimeUTC, site, ws = value, aqPeriod)]
setkey(wsDT, dateTimeUTC, site, aqPeriod)
wrDT <- wdDT[wsDT]
openair::windRose(wrDT, type = "aqPeriod")
```

# Save data

Save data out for predictive models.

Save long form data to [data](../data/) folder.

```{r saveData}
fixedDT[, weekDay := lubridate::wday(dateTimeUTC, label = TRUE, abbr = TRUE)]
f <- paste0(here::here(), "/data/sotonExtract2017_2020_v2.csv")
data.table::fwrite(fixedDT, f)
dkUtils::gzipIt(f)
```

Saved data description:

```{r dataSkim}
skimr::skim(aurnDT)
```

Saved data sites by year:

```{r dataYears}
t <- table(fixedDT$site, fixedDT$year)

kableExtra::kable(t, caption = "Sites available by year") %>%
  kable_styling()
```

Saved pollutants by site:

```{r dataSites}
t <- table(fixedDT$site, fixedDT$pollutant)

kableExtra::kable(t, caption = "Pollutants available by site") %>%
  kable_styling()
```

NB:

 * ws = wind speed
 * wd = wind direction
 * v* = volatiles

We have also produced [wind/pollution roses](sccAirQualExplore_windroses_Wind and pollution roses 2016-2020 (AURN data).html) for these sites.

# Annex

## Missing data {#annexMissing}

Several of these datasets suffer from missing data or have stopped updating. This is visualised below for all data for all sites from January 2020.

```{r testNegNo2, fig.cap="Nitrogen Dioxide data availability and levels over time"}
# dt,xvar, yvar,fillVar, yLab
tileDT <- sotonAirDT[pollutant == "no2" & 
                       dateTimeUTC > as.Date("2020-02-01") &
                       !is.na(value)]
p <- makeTilePlot(tileDT, xVar = "dateTimeUTC", yVar = "site",
                  fillVar = "value",
                  yLab = yLab)

p + scale_x_datetime(date_breaks = "7 day", date_labels =  "%a %d %b")  +
    theme(axis.text.x=element_text(angle=90, hjust=1)) 
```

```{r testNegNox, fig.cap="Oxides of nitrogen data availability and levels over time"}

# dt,xvar, yvar,fillVar, yLab
tileDT <- sotonAirDT[pollutant == "nox" & 
                       dateTimeUTC > as.Date("2020-02-01") &
                       !is.na(value)]
p <- makeTilePlot(tileDT, xVar = "dateTimeUTC", yVar = "site",
                  fillVar = "value",
                  yLab = yLab)

p + scale_x_datetime(date_breaks = "7 day", date_labels =  "%a %d %b")  +
    theme(axis.text.x=element_text(angle=90, hjust=1)) 
```

```{r testNegSo2, fig.cap="Sulphour Dioxide data availability and levels over time"}

# dt,xvar, yvar,fillVar, yLab
tileDT <- sotonAirDT[pollutant == "so2" & 
                       dateTimeUTC > as.Date("2020-02-01") &
                       !is.na(value)]
p <- makeTilePlot(tileDT, xVar = "dateTimeUTC", yVar = "site",
                  fillVar = "value",
                  yLab = yLab)

p + scale_x_datetime(date_breaks = "7 day", date_labels =  "%a %d %b")  +
    theme(axis.text.x=element_text(angle=90, hjust=1)) 
```

```{r testNego3, fig.cap = "Availability and level of o3 data over time"}

tileDT <- sotonAirDT[pollutant == "o3" & 
                       dateTimeUTC > as.Date("2020-02-01") &
                       !is.na(value)]
p <- makeTilePlot(tileDT, xVar = "dateTimeUTC", yVar = "site",
                  fillVar = "value",
                  yLab = yLab)

p + scale_x_datetime(date_breaks = "7 day", date_labels =  "%a %d %b")  +
    theme(axis.text.x=element_text(angle=90, hjust=1)) 
```

```{r testNegPM10, fig.cap = "Availability and level of PM 10 data over time"}
tileDT <- sotonAirDT[pollutant == "pm10" & 
                       dateTimeUTC > as.Date("2020-02-01") &
                       !is.na(value)]
p <- makeTilePlot(tileDT, xVar = "dateTimeUTC", yVar = "site",
                  fillVar = "value",
                  yLab = yLab)

p + scale_x_datetime(date_breaks = "7 day", date_labels =  "%a %d %b")  +
    theme(axis.text.x=element_text(angle=90, hjust=1)) 
```

```{r testNegPM25, fig.cap = "Availability and level of PM 2.5 data over time"}

tileDT <- sotonAirDT[pollutant == "pm2.5" & 
                       dateTimeUTC > as.Date("2020-02-01") &
                       !is.na(value)]
p <- makeTilePlot(tileDT, xVar = "dateTimeUTC", yVar = "site",
                  fillVar = "value",
                  yLab = yLab)

p + scale_x_datetime(date_breaks = "7 day", date_labels =  "%a %d %b")  +
    theme(axis.text.x=element_text(angle=90, hjust=1)) 
```

# Runtime

Report generated using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform` (`r Sys.info()[3]`).

```{r check runtime}
t <- proc.time() - myParams$startTime

elapsed <- t[[3]]
```

Analysis completed in `r elapsed` seconds ( `r round(elapsed/60,2)` minutes).

R packages used in this report:

 * data.table - [@data.table]
 * ggplot2 - [@ggplot2]
 * here - [@here]
 * kableExtra - [@kableExtra]
 * lubridate - [@lubridate]
 * openAir - [@openair]
 * skimr - [@skimr]
 * viridis - [@viridis]
 
# References

