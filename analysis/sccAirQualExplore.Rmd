---
params:
  title: ''
  subtitle: ''
  authors: ''
title: '`r params$title`'
subtitle: '`r params$subtitle`'
author: '`r params$authors`'
date: 'Last run at: `r getRunDateTime()`'
output:
  bookdown::html_document2:
    fig_caption: yes
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: TRUE
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: yes
  bookdown::word_document2:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
    fig_width: 5
always_allow_html: yes
bibliography: '`r path.expand("~/bibliography.bib")`'
---

```{r knitrSetUp, include=FALSE}

# Set knitr options
knitr::opts_chunk$set(echo = FALSE,          # echo code so reader can see what is happening
                      warning = FALSE,
                      message = FALSE,
                      fig_caption = TRUE,
                      fig_height = 6,        # default, make it bigger to stretch vertical axis
                      fig_width = 8,
                      fig_width = 8,         # full width
                      tidy = TRUE)           # tidy up code in case echo = TRUE

```


```{r codeSetup, include=FALSE}

# Load Packages ----
rmdLibs <- c("ggplot2",
            "kableExtra",
            "plotly",
            "skimr")

dkUtils::loadLibraries(rmdLibs)

# Adjust knitr options if required
knitr::opts_chunk$set(echo = TRUE)

# Log compile time:
startTime <- proc.time()

# Functions ----
makeDotPlot <- function(dt, xVar, yVar, byVar, yLab){
  p <- ggplot2::ggplot(dt, aes(x = get(xVar), 
                               y = get(yVar),
                               colour = get(byVar),
                               alpha = 1/100 # https://ggplot2.tidyverse.org/reference/geom_point.html
                               )
                       ) +
    geom_point(size = 1, # small
               shape = 4 # small cross shape
               ) +
    scale_color_discrete(name = eval(byVar)) +
    guides(alpha = FALSE) + # remove alpha legend 
    labs(x = "Time",
         y = eval(yLab)) +  
    theme(legend.position="bottom") +
    guides(colour = guide_legend(nrow = 2)) # forces 2 rows to legend
  return(p)
}

makeTilePlot <- function(dt, xVar, yVar, fillVar, yLab){
  p <- ggplot2::ggplot(dt, aes(x = get(xVar), 
                               y = get(yVar),
                               fill = get(fillVar)
                               )
                       ) +
    geom_tile() +
    scale_fill_continuous(low = "green", high = "red", name = "Value") +
    labs(x = "Time",
         y = yLab) +  
    theme(legend.position="bottom")
  return(p)
}

```

# About

## Contributions

Please note that authorship is alphabetical. Contributions are listed below - see [github](https://github.com/CfSOtago/airQual/commits/master) for details and who to blame for what :-).

 * Ben Anderson (b.anderson@soton.ac.uk `@dataknut`)

## Code

 * https://github.com/CfSOtago/airQual/commits/master

## Citation

If you wish to refer to any of the material from this report please cite as:

 * Anderson, B., (`r format(Sys.time(), format = "%Y")`) `r params$myTitle`: `r params$mySubTitle` , University of Southampton: Southampton, UK.

Report circulation:

 * Public
 
Report purpose: 
 
 * to explore (official) Southampton City Council Air Quality data (http://southampton.my-air.uk)

This work is (c) `r format(Sys.time(), format = "%Y")` the University of Southampton.
 
# Introduction

```{r loadData}

# done in makefile
```

Data downloaded from http://southampton.my-air.uk. See also https://www.southampton.gov.uk/environmental-issues/pollution/air-quality/.

Southampton City Council collects various forms of air quality data at the sites shown in \@ref(tab:showSites). WHO publishes [information](https://www.who.int/news-room/fact-sheets/detail/ambient-(outdoor)-air-quality-and-health) on the health consequences and "acceptable" exposure levels for each of these.


```{r showSites}

lDT <- data.table::melt(dt,
                     id.vars=c("site","obsDateTime"),
                     measure.vars = c("co","nox","nox2","noxes","oz","pm10","pm2_5","so2"),
                     value.name = "value" # varies 
  )

# remove NA
lDT <- lDT[!is.na(value)]

t <- lDT[,.(from = min(obsDateTime),
           to = max(obsDateTime),
           nObs = .N), keyby = .(site, variable)]

kableExtra::kable(t, caption = "Dates data available by site and measure",
                  digits = 2) %>%
  kable_styling()
```

# Summarise data

Summarise previously downloaded and processed data...

```{r summariseData}

skimr::skim(dt)

t <- dt[, .("co: Carbon Monoxide, mg/m3" = mean(co, na.rm = TRUE),
            "nox = Nitric Oxide, ug/m3" = mean(nox, na.rm = TRUE),
            "nox2 = Nitrogen Dioxide, ug/m3" = mean(nox2, na.rm = TRUE),
            "noxes = Oxides of Nitrogen, ug/m3" = mean(noxes, na.rm = TRUE),
            "oz = ozone, ug/m3" = mean(oz, na.rm = TRUE),
            "pm10, ug/m3" = mean(pm10, na.rm = TRUE),
            "pm2_5, ug/m3" = mean(pm2_5, na.rm = TRUE),
            "so2 = Sulphur Dioxide, ug/m3" = mean(so2, na.rm = TRUE)
            ), keyby = .(site)]

kableExtra::kable(t, caption = "Mean values per site (NaN indicates not measured)") %>%
  kable_styling()

```

Table \@ref(tab:summariseData) gives an indication of the availability of the different measures.


# Analysis

In this section we present graphical analysis of the previoulsy downloaded data. Note this is just a snapshot of the data available.

## Nitrogen Dioxide


```{r nox2Summary}
yLab <- "Nitrogen Dioxide (ug/m3)"

t <- lDT[variable == "nox2", .(mean = mean(value, na.rm = TRUE),
            sd = sd(value, na.rm = TRUE),
            min = min(value, na.rm = TRUE),
            max = max(value, na.rm = TRUE)), keyby = .(site)]
kableExtra::kable(t, caption = "Summary of nox2 data") %>%
  kable_styling()
```

Table \@ref(tab:nox2Summary) suggests that there may be a few (`r nrow(dt[nox2 < 0])`) negative values. These are summarised in \@ref(tab:testNegnox2) while Figure \@ref(fig:testNegnox2) shows the availability and levels of the pollutant data over time.

```{r testNegnox2, fig.cap="Nitrogen Dioxide data availability and levels over time"}


t <- head(dt[nox2 <0], 10)
kableExtra::kable(t, caption = "Negative nox2 values (up to first 6)") %>%
  kable_styling()

t <- table(dt[nox < 0]$site)
kableExtra::kable(t, caption = "Negative nox2 values (count by site)") %>%
  kable_styling()

# dt,xvar, yvar,fillVar, yLab
p <- makeTilePlot(lDT[variable == "nox2"], xVar = "obsDateTime", yVar = "site",
                  fillVar = "value",
                  yLab = yLab)

p
```




```{r plotNox2Hourly, fig.cap="Nitrogen Dioxide levels, Southampton (hourly)"}
# p <- ggplot2::ggplot(dt, aes(x = obsDateTime, 
#                              y = nox2,
#                              colour = site,
#                              alpha = 0.1)) +
#   geom_point(shape=4, size = 1)

t <- lDT[variable == "nox2" & value > 200][order(-value)]

kableExtra::kable(caption = paste0("Values greater than WHO threshold (NO2 > ", 
                                   hourlynox2Threshold_WHO , ")"), 
                  head(t, 10)) %>%
  kable_styling()

p <- makeDotPlot(lDT[variable == "nox2"], 
                 xVar = "obsDateTime", 
                 yVar = "value", 
                 byVar = "site", 
                 yLab = yLab)

p <- p + geom_hline(yintercept = hourlynox2Threshold_WHO) +
  labs(caption = "Reference line = WHO hourly guideline threshold")

if(doPlotly){
  plotly::ggplotly(p) # interactive
} else {
  p
}

```

Figure \@ref(fig:plotNox2Hourly) shows hourly values for all sites. In the study period there were `r nrow(t)` hours when the hourly Nitrogen Dioxide level breached WHO guidelines. The worst 10 cases are shown in Table \@ref(tab:plotNox2Hourly).

```{r plotNox2Daily, fig.cap="Nitrogen Dioxide levels, Southampton (daily mean"}
lDT[, obsDate := lubridate::date(obsDateTime)]

plotDT <- lDT[variable == "nox2", .(mean = mean(value, na.rm = TRUE)),
             keyby = .(obsDate, site)]

p <- makeDotPlot(plotDT, 
                 xVar = "obsDate", 
                 yVar = "mean", 
                 byVar = "site", 
                 yLab = yLab)

p <- p +
  geom_smooth() + # add smoothed line
  labs(caption = "Trend line = Generalized additive model (gam) with integrated smoothness estimation")

if(doPlotly){
  plotly::ggplotly(p) # interactive
} else {
  p
}

```


Figure \@ref(fig:plotNox2Daily) shows daily mean values for all sites over time and includes smoother trend lines for each site.

Clearly the mean daily values show less variance (and less extremes) than the hourly data and there has also been a decreasing trend over time.


## PM 10

PM 10 data: has more sensors and wider coverage than PM2.5

```{r pm10Summary}
yLab <- "PM 10 (ug/m3)"

t <- dt[, .(mean = mean(pm10, na.rm = TRUE),
            sd = sd(pm10, na.rm = TRUE),
            min = min(pm10, na.rm = TRUE),
            max = max(pm10, na.rm = TRUE)), keyby = .(site)]
kableExtra::kable(t, caption = "Summary of pm10 data") %>%
  kable_styling()
```

Table \@ref(tab:pm10Summary) suggests that there may be a few (`r nrow(dt[pm10 < 0])`) negative values. These are shown in \@ref(tab:testNegpm10) while \@ref(fig:testNegpm10) shows data availability and PM 10 levels over time at each site.

```{r testNegpm10, fig.cap = "Availability and level of PM 10 data over time"}
t <- head(dt[pm10 <0], nrow(dt[pm10 < 0]))
kableExtra::kable(head(t), caption = "Negative PM10 values - first 6") %>%
  kable_styling()

p <- makeTilePlot(lDT[variable == "pm10"], xVar = "obsDateTime", yVar = "site",
                  fillVar = "value",
                  yLab = yLab)

p
```

Figure \@ref(fig:plotPM10Hourly) shows hourly PM 10 values for all sites and suggests there may be an extreme outlier (see Table \@ref(fig:plotPM10Hourly)).

```{r plotPM10Hourly, fig.cap="PM10 levels, Southampton (hourly)"}
t <- lDT[variable == "pm10" & value > 100][order(-value)]

kableExtra::kable(caption = "10 highest hourly values (PM 10 > 100)", head(t)) %>%
  kable_styling()

p <- makeDotPlot(lDT[variable == "pm10"], 
                 xVar = "obsDateTime", 
                 yVar = "value", 
                 byVar = "site", 
                 yLab = yLab)


if(doPlotly){
  plotly::ggplotly(p) # interactive
} else {
  p
}

pm10DT <- dt[!is.na(pm10)]
```

```{r plotPM10Daily, fig.cap="PM10 levels, Southampton (daily mean, WHO daily threshold shown in red - use mouse to hover over data)"}

plotDT <- lDT[variable == "pm10", .(mean = mean(value, na.rm = TRUE)),
             keyby = .(obsDate, site)]

extremePm10Daily <- plotDT[mean > dailyPm10Threshold_WHO][order(-mean)]

kableExtra::kable(caption = paste0("10 highest values greater than WHO threshold (PM 10 > ", 
                                   dailyPm10Threshold_WHO , ")"), 
                  digits = 2,
                  head(extremePm10Daily, 10)) %>%
  kable_styling()

p <- makeDotPlot(plotDT, 
                 xVar = "obsDate", 
                 yVar = "mean", 
                 byVar = "site", 
                 yLab = yLab)

p <- p + 
  geom_hline(yintercept = dailyPm10Threshold_WHO) +
  geom_smooth() + # add smoothed line
  labs(caption = "Trend line = Generalized additive model (gam) with integrated smoothness estimation")


if(doPlotly){
  plotly::ggplotly(p) # interactive
} else {
  p
}

```


Figure \@ref(fig:plotPM10Daily) shows daily values for all sites and indicates the `r nrow(t)` that cross the [WHO PM10 daily mean exposure threshold](https://www.who.int/news-room/fact-sheets/detail/ambient-(outdoor)-air-quality-and-health) (`r dailyPm10Threshold_WHO`) - see Table \@ref(tab:plotPM10Daily).

## PM 2.5


```{r pm25Summary}
yLab <- "PM 2.5 (ug/m3)"

t <- dt[, .(mean = mean(pm2_5, na.rm = TRUE),
            sd = sd(pm2_5, na.rm = TRUE),
            min = min(pm2_5, na.rm = TRUE),
            max = max(pm2_5, na.rm = TRUE)), keyby = .(site)]
kableExtra::kable(t, caption = "Summary of pm2_5 data") %>%
  kable_styling()
```

Table \@ref(tab:pm25Summary) suggests that there may be a few (`r nrow(dt[pm2_5 < 0])`) negative values. These are shown in \@ref(tab:testNegpm25) while \@ref(fig:testNegpm25) shows data availability and PM 2.5 levels over time at each site.

```{r testNegpm25, fig.cap = "Availability and level of PM 10 data over time"}
t <- head(dt[pm2_5 <0], nrow(dt[pm2_5 < 0]))
kableExtra::kable(head(t), caption = "Negative pm2_5 values - first 6") %>%
  kable_styling()

p <- makeTilePlot(lDT[variable == "pm2_5"], xVar = "obsDateTime", yVar = "site",
                  fillVar = "value",
                  yLab = yLab)

p
```

Figure \@ref(fig:plotPM25Hourly) shows hourly values for all sites.

```{r plotPM25Hourly, fig.cap="PM2_5 levels, Southampton (hourly - use mouse to hover over data)"}

t <- lDT[variable == "pm2_5" & value > 200][order(-value)]

kableExtra::kable(caption = "Extreme hourly values (PM 2.5 > 50)", t) %>%
  kable_styling()

p <- makeDotPlot(lDT[variable == "pm2_5"], 
                 xVar = "obsDateTime", 
                 yVar = "value", 
                 byVar = "site", 
                 yLab = yLab)


if(doPlotly){
  plotly::ggplotly(p) # interactive
} else {
  p
}

```

```{r plotPM25Daily, fig.cap="PM2_5 levels, Southampton (daily mean)"}
plotDT <- lDT[variable == "pm2_5", .(mean = mean(value, na.rm = TRUE)),
             keyby = .(obsDate, site)]

extremePm25Daily <- plotDT[mean > dailyPm2.5Threshold_WHO][order(-mean)]

kableExtra::kable(caption = paste0("10 highest values greater than WHO threshold (PM 2.5 > ", 
                                   dailyPm2.5Threshold_WHO , ")"), 
                  digits = 2,
                  head(extremePm25Daily,10)) %>%
  kable_styling()

p <- makeDotPlot(plotDT, 
                 xVar = "obsDate", 
                 yVar = "mean", 
                 byVar = "site", 
                 yLab = yLab)

p <- p + 
  geom_hline(yintercept = dailyPm2.5Threshold_WHO) +
  geom_smooth() + #add smoothed line
  labs(caption = "Trend line = Generalized additive model (gam) with integrated smoothness estimation")


if(doPlotly){
  plotly::ggplotly(p) # interactive
} else {
  p
}

```


Figure \@ref(fig:plotPM25Daily) shows daily values for all sites and indicates that the [WHO PM2_5 daily mean exposure threshold](https://www.who.int/news-room/fact-sheets/detail/ambient-(outdoor)-air-quality-and-health) (`r dailyPm2.5Threshold_WHO`) was breached on `r nrow(t)` days. The 10 worst cases are shown in Table \@ref(tab:plotPM25Daily).

# Observations

 * Nitorgen Dioxide levels appear to be trending downwards
 * For particulates the trend is more complex with PM10 trending down but PM2.5 trending up. 
     * Something happened on the 27th October 2019 at 20:00. There are spikes on all hourly plots (although this is masked in the daily plots). Could it have been a [cruise ship](https://www.iglucruise.com/oceana/27th-october-2019_c221337) leaving? 
     * Something else happened on the 2nd December 2019 at 21:00. Was this another ship?

# Annex

## Nitrogen Dioxide

```{r skimNox2All}

t <- lDT[variable == "nox2"]

skim(t)
```

```{r extremeNox2All}

t <- lDT[variable == "nox2" & value > hourlynox2Threshold_WHO][order(-value)]

kableExtra::kable(caption = paste0("Values greater than WHO threshold (NO2 > ", 
                                   hourlynox2Threshold_WHO , ")"), 
                  t) %>%
  kable_styling()
```


## PM 10

```{r skimPm10All}

t <- lDT[variable == "pm10"]

skim(t)
```

```{r extremeNPm10All}

kableExtra::kable(caption = paste0("PM 10 values greater than WHO threshold (NO2 > ", 
                                   hourlynox2Threshold_WHO , ")"), 
                  extremePm10Daily) %>%
  kable_styling()
```

## PM 2.5

```{r skimPm25All}

t <- lDT[variable == "pm2_5"]

skim(t)
```

```{r extremePm25All}

kableExtra::kable(caption = paste0("PM 2.5 values greater than WHO threshold (NO2 > ", 
                                   hourlynox2Threshold_WHO , ")"), 
                  extremePm25Daily) %>%
  kable_styling()
```


# Runtime

Report generated using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform` (`r Sys.info()[3]`).

```{r check runtime}
t <- proc.time() - startTime

elapsed <- t[[3]]
```

Analysis completed in `r elapsed` seconds ( `r round(elapsed/60,2)` minutes).

R packages used:

 * data.table - [@data.table]
 * ggplot2 - [@ggplot2]
 * here - [@here]
 * kableExtra - [@kableExtra]
 * lubridate - [@lubridate]
 * plotly - [@plotly]
 * skimr - [@skimr]
            
# References

