---
params:
  title: 'Air Quality in Southampton (UK)'
  subtitle: 'Exploring "official" data'
  author: 'Ben Anderson (b.anderson@soton.ac.uk `@dataknut`)'
title: '`r params$title`'
subtitle: '`r params$subtitle`'
author: '`r params$author`'
date: 'Last run at: `r `r Sys.time()`'
output:
  bookdown::html_document2:
    fig_caption: yes
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: TRUE
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: yes
  bookdown::word_document2:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
    fig_width: 5
always_allow_html: yes
bibliography: '`r path.expand("~/bibliography.bib")`'
---

```{r knitrSetUp, include=FALSE}

# Set knitr options
knitr::opts_chunk$set(echo = FALSE,          # echo code so reader can see what is happening
                      warning = FALSE,
                      message = FALSE,
                      fig_caption = TRUE,
                      fig_height = 6,        # default, make it bigger to stretch vertical axis
                      fig_width = 8,
                      fig_width = 8,         # full width
                      tidy = TRUE)           # tidy up code in case echo = TRUE

```


```{r codeSetup, include=FALSE}

# Load Packages ----
library(dkUtils)

myLibs <- c("data.table",
            "ggplot2",
            "here",
            "kableExtra",
            "lubridate",
            "plotly",
            "skimr")

dkUtils::loadLibraries(myLibs)              # Load script specific packages

# Project Settings ----
projLoc <- here::here()


dPath <- "~/Data/NZ_mfe/airQuality/"

# https://www.who.int/news-room/fact-sheets/detail/ambient-(outdoor)-air-quality-and-health
annualPm10Threshold_WHO <- 20
dailyPm10Threshold_WHO <- 50 
annualPm2.5Threshold_WHO <- 10
dailyPm2.5Threshold_WHO <- 25 

# Adjust knitr options if required
knitr::opts_chunk$set(echo = TRUE)

# Log compile time:
startTime <- proc.time()

# Functions ----
makeTilePlot <- function(dt,yvar,byvar){
  p <- ggplot2::ggplot(dt, aes(x = ba_date, 
                               y = get(byvar), 
                               fill = get(yvar)
                               )
                       ) +
    geom_tile() +
    scale_fill_continuous(low = "green", high = "red") +
    labs(x = "Date")
  return(p)
}

makeLinePlot <- function(dt,yvar,byvar){
  p <- ggplot2::ggplot(dt, aes(x = ba_date, 
                               y = get(yvar),
                               colour = get(byvar)
                               )
                       ) +
    geom_line() +
    labs(x = "Date")
  return(p)
}

```

# About

## Contributions

Please note that authorship is alphabetical. Contributions are listed below - see [github](https://github.com/CfSOtago/airQual/commits/master) for details and who to blame for what :-).

 * Ben Anderson (b.anderson@soton.ac.uk `@dataknut`)

## Code

 * https://github.com/CfSOtago/airQual/commits/master

## Citation

If you wish to refer to any of the material from this report please cite as:

 * Anderson, B., (`r format(Sys.time(), format = "%Y")`) `r params$myTitle`: `r params$mySubTitle` , University of Southampton: Southampton, UK.

Report circulation:

 * Public
 
Report purpose: 
 
 * to explore `official` Southampton City Council Air Quality data (http://southampton.my-air.uk)

This work is (c) `r format(Sys.time(), format = "%Y")` the University of Southampton.
 
# Introduction

Data downloaded from http://southampton.my-air.uk. See also https://www.southampton.gov.uk/environmental-issues/pollution/air-quality/.

# Load data

Load previously processed data...

```{r getData}

dataPath <- path.expand("~/Data/SCC/airQual/")

# merge them all
files <- list.files(paste0(dataPath, "/processed/"), pattern = "*.gz", full.names = TRUE)

l <- lapply(files, data.table::fread)
dt <- rbindlist(l, fill = TRUE)

skimr::skim(dt)

dt[, obsDateTime := lubridate::ymd_hm(MeasurementDateGMT)]

t <- dt[, .("co: Carbon Monoxide, mg/m3" = mean(co, na.rm = TRUE),
            "nox = Nitric Oxide, ug/m3" = mean(nox, na.rm = TRUE),
            "nox2 = Nitrogen Dioxide, ug/m3" = mean(nox2, na.rm = TRUE),
            "noxes = Oxides of Nitrogen, ug/m3" = mean(noxes, na.rm = TRUE),
            "oz = ozone, ug/m3" = mean(oz, na.rm = TRUE),
            "pm10, ug/m3" = mean(pm10, na.rm = TRUE),
            "pm2_5, ug/m3" = mean(pm2_5, na.rm = TRUE),
            "so2 = Sulphur Dioxide, ug/m3" = mean(so2, na.rm = TRUE)
            ), keyby = .(site)]

kableExtra::kable(t, caption = "Mean values per site (NaN indicates not measured)") %>%
  kable_styling()

```

Table \@ref(tab:getData) gives an indication of the availability of the different measures.


# Nitric Oxide


```{r noxSummary}
t <- dt[, .(mean = mean(nox, na.rm = TRUE),
            sd = sd(nox, na.rm = TRUE),
            min = min(nox, na.rm = TRUE),
            max = max(nox, na.rm = TRUE)), keyby = .(site)]
kableExtra::kable(t, caption = "Summary of nox data") %>%
  kable_styling()
```

Table \@ref(tab:noxSummary) suggests that there may be a few (`r nrow(dt[nox < 0])`) negative values. These are summarised in \@ref(tab:testNegnox).

```{r testNegnox, fig.cap="nox data availability"}
t <- head(dt[nox <0], 10)
kableExtra::kable(t, caption = "Negative nox values (first 10)") %>%
  kable_styling()

t <- table(dt[nox < 0]$site)
kableExtra::kable(t, caption = "Negative nox values (count by site)") %>%
  kable_styling()

p <- ggplot2::ggplot(dt, aes(x = obsDateTime, 
                               y = site, 
                               fill = nox
                               )
                       ) +
    geom_tile() +
    scale_fill_continuous(low = "green", high = "red") +
    labs(x = "Time")
p
```


Figure \@ref(fig:plotNoxHourly) shows hourly values for all sites.

```{r plotNoxHurly, fig.cap="Nitric Oxide levels, Southampton (hourly)"}
p <- ggplot2::ggplot(dt, aes(x = obsDateTime, y = nox, colour = site)) +
  geom_line()

p <- p +  theme(legend.position="bottom")

plotly::ggplotly(p) # interactive

```

```{r plotNoxDaily, fig.cap="Nitric Oxide levels, Southampton (daily mean)"}
dt[, obsDate := lubridate::date(obsDateTime)]
plotDT <- dt[, .(mean_nox = mean(nox, na.rm = TRUE)),
             keyby = .(obsDate, site)]

p <- ggplot2::ggplot(plotDT, aes(x = obsDate, y = mean_nox, colour = site)) +
  geom_line()

p <- p +  theme(legend.position="bottom")

plotly::ggplotly(p) # interactive

```


Figure \@ref(fig:plotNoxDaily) shows daily values for all sites.

Clearly the mean daily values show less variance (and less extremes) than the hourly data.


# PM 10

PM 10 data: has more sensors and wider coverage than PM2.5

```{r pm10Summary}
t <- dt[, .(mean = mean(pm10, na.rm = TRUE),
            sd = sd(pm10, na.rm = TRUE),
            min = min(pm10, na.rm = TRUE),
            max = max(pm10, na.rm = TRUE)), keyby = .(site)]
kableExtra::kable(t, caption = "Summary of pm10 data") %>%
  kable_styling()
```

Table \@ref(tab:pm10Summary) suggests that there may be a few (`r nrow(dt[pm10 < 0])`) negative values. These are shown in \@ref(tab:testNegpm10).

```{r testNegpm10}
t <- head(dt[pm10 <0], nrow(dt[pm10 < 0]))
kableExtra::kable(t, caption = "Negative PM10 values") %>%
  kable_styling()

p <- ggplot2::ggplot(dt, aes(x = obsDateTime, 
                               y = site, 
                               fill = pm10
                               )
                       ) +
    geom_tile() +
    scale_fill_continuous(low = "green", high = "red") +
    labs(x = "Time")
p
```

Figure \@ref(fig:plotPM10Hourly) shows hourly values for all sites.

```{r plotPM10Hourly, fig.cap="PM10 levels, Southampton (hourly)"}

p <- ggplot2::ggplot(dt, aes(x = obsDateTime, y = pm10, colour = site)) +
  geom_line()

p <- p +  theme(legend.position="bottom")

plotly::ggplotly(p) # interactive

pm10DT <- dt[!is.na(pm10)]
```

```{r plotPM10Daily, fig.cap="PM10 levels, Southampton (daily mean, WHO daily threshold shown in red)"}
dt[, obsDate := lubridate::date(obsDateTime)]
plotDT <- dt[, .(mean_pm10 = mean(pm10, na.rm = TRUE)),
             keyby = .(obsDate, site)]

p <- ggplot2::ggplot(plotDT, aes(x = obsDate, y = mean_pm10, colour = site)) +
  geom_line()

p <- p +  theme(legend.position="bottom") +
  geom_hline(yintercept = dailyPm10Threshold_WHO, colour = "red")

p

plotly::ggplotly(p) # interactive

```


Figure \@ref(fig:plotPM10Daily) shows daily values for all sites and indicates those that cross the:

 * WHO PM10 daily mean exposure threshold (`r dailyPm10Threshold_WHO`) - see https://www.who.int/news-room/fact-sheets/detail/ambient-(outdoor)-air-quality-and-health

Clearly the mean daily values show less variance (and less extremes) than the hourly data.

# PM 2.5


```{r pm25Summary}
t <- dt[, .(mean = mean(pm2_5, na.rm = TRUE),
            sd = sd(pm2_5, na.rm = TRUE),
            min = min(pm2_5, na.rm = TRUE),
            max = max(pm2_5, na.rm = TRUE)), keyby = .(site)]
kableExtra::kable(t, caption = "Summary of pm2_5 data") %>%
  kable_styling()
```

Table \@ref(tab:pm25Summary) suggests that there may be a few (`r nrow(dt[pm2_5 < 0])`) negative values. These are shown in \@ref(tab:testNeg25).

```{r testNegpm25}
t <- head(dt[pm2_5 <0], nrow(dt[pm2_5 < 0]))
kableExtra::kable(t, caption = "Negative pm2_5 values") %>%
  kable_styling()

p <- ggplot2::ggplot(dt, aes(x = obsDateTime, 
                               y = site, 
                               fill = pm2_5
                               )
                       ) +
    geom_tile() +
    scale_fill_continuous(low = "green", high = "red") +
    labs(x = "Time")
p
```

Figure \@ref(fig:plotPM25Hourly) shows hourly values for all sites.

```{r plotPM25Hourly, fig.cap="PM2_5 levels, Southampton (hourly)"}

p <- ggplot2::ggplot(dt, aes(x = obsDateTime, y = pm2_5, colour = site)) +
  geom_line()

p <- p +  theme(legend.position="bottom")

plotly::ggplotly(p) # interactive

```

```{r plotPM25Daily, fig.cap="PM2_5 levels, Southampton (daily mean, WHO daily threshold shown in red)"}
dt[, obsDate := lubridate::date(obsDateTime)]
plotDT <- dt[, .(mean_pm2_5 = mean(pm2_5, na.rm = TRUE)),
             keyby = .(obsDate, site)]

p <- ggplot2::ggplot(plotDT, aes(x = obsDate, y = mean_pm2_5, colour = site)) +
  geom_line()

p <- p +  theme(legend.position="bottom") +
  geom_hline(yintercept = dailyPm2.5Threshold_WHO, colour = "red")


plotly::ggplotly(p) # interactive

```


Figure \@ref(fig:plotPM25Daily) shows daily values for all sites and indicates those that cross the:

 * WHO PM2_5 daily mean exposure threshold (`r dailyPm2.5Threshold_WHO`) - see https://www.who.int/news-room/fact-sheets/detail/ambient-(outdoor)-air-quality-and-health

Clearly the mean daily values show less variance (and less extremes) than the hourly data.

# Observations

Something happened on the 27th October 2019 at 20:00. There are spikes on all hourly plots (although this is masked in the daily plots). Could it have been a [cruise ship](https://www.iglucruise.com/oceana/27th-october-2019_c221337) leaving?  S

Something else happened on the 2nd December 2019 at 21:00. Was this another ship?

# Runtime

Report generated using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform` (`r Sys.info()[3]`).

```{r check runtime}
t <- proc.time() - startTime

elapsed <- t[[3]]
```

Analysis completed in `r elapsed` seconds ( `r round(elapsed/60,2)` minutes).

R packages used:

 * data.table - [@data.table]
 * ggplot2 - [@ggplot2]
 * here - [@here]
 * kableExtra - [@kableExtra]
 * lubridate - [@lubridate]
 * plotly - [@plotly]
 * skimr - [@skimr]
            
# References

